{% extends "base.html" %}

{% block title %}å‡¦ç†å±¥æ­´ - recapisure{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>å‡¦ç†å±¥æ­´
                        </h4>
                        <div>
                            <button class="btn btn-light btn-sm" onclick="exportHistory()">
                                <i class="fas fa-download me-1"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                            </button>
                            <button class="btn btn-outline-light btn-sm ms-2" onclick="clearHistory()">
                                <i class="fas fa-trash me-1"></i>å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="typeFilter" class="form-label">å‡¦ç†ã‚¿ã‚¤ãƒ—</label>
                            <select class="form-select" id="typeFilter" onchange="filterHistory()">
                                <option value="all">ã™ã¹ã¦</option>
                                <option value="summarize">è¦ç´„</option>
                                <option value="expand">å±•é–‹</option>
                                <option value="url_summarize">URLè¦ç´„</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="dateFilter" class="form-label">æœŸé–“</label>
                            <select class="form-select" id="dateFilter" onchange="filterHistory()">
                                <option value="all">ã™ã¹ã¦</option>
                                <option value="today">ä»Šæ—¥</option>
                                <option value="week">éå»1é€±é–“</option>
                                <option value="month">éå»1ãƒ¶æœˆ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="searchInput" class="form-label">æ¤œç´¢</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="çµæœã‚’æ¤œç´¢..." onkeyup="filterHistory()">
                        </div>
                    </div>

                    <!-- å±¥æ­´ãƒªã‚¹ãƒˆ -->
                    <div id="historyContainer">
                        <div class="text-center py-5" id="emptyState">
                            <i class="fas fa-history fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">å‡¦ç†å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</h5>
                            <p class="text-muted mb-0">
                                <a href="/" class="btn btn-primary">
                                    <i class="fas fa-magic me-1"></i>æœ€åˆã®å‡¦ç†ã‚’é–‹å§‹
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-text me-2"></i>å‡¦ç†è©³ç´°
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- åŸºæœ¬æƒ…å ± -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <small class="text-muted">å‡¦ç†æ—¥æ™‚</small><br>
                                <strong id="modalTimestamp"></strong>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <small class="text-muted">å‡¦ç†ã‚¿ã‚¤ãƒ—</small><br>
                                <span id="modalType" class="badge bg-info"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <small class="text-muted">è¨€èª</small><br>
                                <strong id="modalLanguage"></strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- â­ å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå·¦ï¼‰ã¨è¦ç´„çµæœï¼ˆå³ï¼‰ã‚’ä¸¦ã¹ã¦è¡¨ç¤º -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100" id="modalOriginal">
                            <div class="card-header bg-secondary text-white py-2">
                                <i class="fas fa-file-alt me-1"></i>
                                <strong>å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ</strong>
                                <span class="badge bg-light text-dark ms-2" id="modalOriginalLength">0æ–‡å­—</span>
                            </div>
                            <div class="card-body p-0">
                                <div id="modalOriginalText" 
                                     style="height: 300px; overflow-y: auto; padding: 12px; background-color: #f8f9fa; white-space: pre-wrap; font-size: 14px; line-height: 1.6;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white py-2">
                                <i class="fas fa-compress-alt me-1"></i>
                                <strong>è¦ç´„çµæœ</strong>
                                <span class="badge bg-light text-dark ms-2" id="modalResultLength">0æ–‡å­—</span>
                            </div>
                            <div class="card-body p-0">
                                <div id="modalResultText" 
                                     style="height: 300px; overflow-y: auto; padding: 12px; background-color: #e8f5e9; white-space: pre-wrap; font-size: 14px; line-height: 1.6;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åœ§ç¸®ç‡è¡¨ç¤º -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info mb-0 py-2">
                            <i class="fas fa-chart-pie me-2"></i>
                            <strong>åœ§ç¸®ç‡:</strong> <span id="modalCompressionRate">-</span>
                            <span class="ms-3"><strong>å®Ÿè¡Œæ™‚é–“:</strong> <span id="modalExecTime">-</span></span>
                            <span class="ms-3"><strong>å“è³ªã‚¹ã‚³ã‚¢:</strong> <span id="modalQualityScore">-</span></span>
                        </div>
                    </div>
                </div>
                
                <!-- â­ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="row mt-3" id="modalKeywordsSection">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-warning text-dark py-2">
                                <i class="fas fa-tags me-1"></i>
                                <strong>æŠ½å‡ºã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</strong>
                            </div>
                            <div class="card-body py-2" id="modalKeywords">
                                <span class="text-muted">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="copyModalOriginal()">
                    <i class="fas fa-copy me-1"></i>å…¥åŠ›ã‚’ã‚³ãƒ”ãƒ¼
                </button>
                <button type="button" class="btn btn-outline-success" onclick="copyModalResult()">
                    <i class="fas fa-copy me-1"></i>çµæœã‚’ã‚³ãƒ”ãƒ¼
                </button>
                <button type="button" class="btn btn-primary" onclick="saveModalResult()">
                    <i class="fas fa-download me-1"></i>ä¿å­˜
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allHistory = [];
let filteredHistory = [];
let currentDetail = null;

$(document).ready(function() {
    loadHistory();
});

function loadHistory() {
    $.get('/api/history', function(data) {
        if (data.success) {
            allHistory = data.history || [];
            filteredHistory = [...allHistory];
            displayHistory();
        } else {
            console.error('å±¥æ­´ã®å–å¾—ã«å¤±æ•—:', data.error);
        }
    }).fail(function(xhr, status, error) {
        console.error('å±¥æ­´APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
    });
}

function displayHistory() {
    const container = $('#historyContainer');
    const emptyState = $('#emptyState');
    
    if (filteredHistory.length === 0) {
        emptyState.show();
        return;
    }
    
    emptyState.hide();
    
    let html = '';
    // æœ€æ–°é †ï¼ˆreverseã›ãšã«ãã®ã¾ã¾è¡¨ç¤ºï¼‰
    filteredHistory.forEach((item, index) => {
        const typeInfo = getTypeInfo(item.operation_type || item.type || 'summarize');
        const date = new Date(item.created_at || item.timestamp).toLocaleString('ja-JP');
        const result = item.result_text || item.result || '';
        const original = item.original_text || '';
        const execTime = item.execution_time || 0;
        const qualityScore = item.quality_score || 0;
        const keywords = item.keywords || [];
        
        // è¨€èªæƒ…å ±
        const sourceLang = item.source_lang || 'auto';
        const targetLang = item.target_lang || 'jpn_Jpan';
        
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¿ã‚°ã‚’ç”Ÿæˆ
        const keywordsHtml = keywords.length > 0 
            ? `<div class="mb-2">
                <i class="fas fa-tags me-1 text-muted"></i>
                ${keywords.slice(0, 5).map(k => `<span class="badge bg-light text-dark me-1">${escapeHtml(k)}</span>`).join('')}
                ${keywords.length > 5 ? `<span class="text-muted small">+${keywords.length - 5}</span>` : ''}
               </div>`
            : '';
        
        html += `
            <div class="card mb-3 history-item">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="card-title mb-2">
                                <i class="fas fa-calendar-alt me-1 text-muted"></i>
                                ${date}
                                <span class="badge bg-${typeInfo.color} ms-2">
                                    <i class="${typeInfo.icon} me-1"></i>${typeInfo.name}
                                </span>
                                ${qualityScore > 0 ? `<span class="badge bg-${qualityScore >= 80 ? 'success' : qualityScore >= 60 ? 'warning' : 'secondary'} ms-1" title="å“è³ªã‚¹ã‚³ã‚¢">
                                    <i class="fas fa-star me-1"></i>${Math.round(qualityScore)}ç‚¹
                                </span>` : ''}
                            </h6>
                            
                            <!-- è¨€èªæƒ…å ± -->
                            <p class="card-text text-muted small mb-2">
                                <i class="fas fa-language me-1"></i>
                                ${formatLanguage(sourceLang)} â†’ ${formatLanguage(targetLang)}
                            </p>
                            
                            <!-- â­ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º -->
                            ${keywordsHtml}
                            
                            ${original ? `
                                <p class="card-text text-muted small mb-2">
                                    <strong>å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ:</strong> ${escapeHtml(original.substring(0, 100))}${original.length > 100 ? '...' : ''}
                                </p>
                            ` : ''}
                            
                            <p class="card-text mb-2">
                                <strong>çµæœ:</strong> ${escapeHtml(result.substring(0, 150))}${result.length > 150 ? '...' : ''}
                            </p>
                        </div>
                        <div class="col-md-4">
                            <div class="text-end">
                                <div class="mb-2">
                                    <small class="text-muted">å®Ÿè¡Œæ™‚é–“</small><br>
                                    <strong class="text-success">${Number(execTime).toFixed(2)}s</strong>
                                </div>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewDetail(${index})">
                                        <i class="fas fa-eye me-1"></i>è©³ç´°
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="copyResultByIndex(${index})">
                                        <i class="fas fa-copy me-1"></i>ã‚³ãƒ”ãƒ¼
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.html(html);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatLanguage(langCode) {
    const langMap = {
        'jpn_Jpan': 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª',
        'eng_Latn': 'ğŸ‡ºğŸ‡¸ è‹±èª',
        'zho_Hans': 'ğŸ‡¨ğŸ‡³ ä¸­å›½èª(ç°¡)',
        'zho_Hant': 'ğŸ‡¹ğŸ‡¼ ä¸­å›½èª(ç¹)',
        'kor_Hang': 'ğŸ‡°ğŸ‡· éŸ“å›½èª',
        'fra_Latn': 'ğŸ‡«ğŸ‡· ãƒ•ãƒ©ãƒ³ã‚¹èª',
        'deu_Latn': 'ğŸ‡©ğŸ‡ª ãƒ‰ã‚¤ãƒ„èª',
        'spa_Latn': 'ğŸ‡ªğŸ‡¸ ã‚¹ãƒšã‚¤ãƒ³èª',
        'auto': 'ğŸ” è‡ªå‹•æ¤œå‡º'
    };
    return langMap[langCode] || langCode;
}

function getTypeInfo(type) {
    const types = {
        summarize: { name: 'è¦ç´„', icon: 'fas fa-compress-alt', color: 'primary' },
        short: { name: 'é€šå¸¸è¦ç´„', icon: 'fas fa-compress-alt', color: 'primary' },
        long: { name: 'è©³ç´°è¦ç´„', icon: 'fas fa-compress-alt', color: 'info' },
        expand: { name: 'å±•é–‹', icon: 'fas fa-expand-alt', color: 'success' },
        url_summarize: { name: 'URLè¦ç´„', icon: 'fas fa-globe', color: 'info' },
        url: { name: 'URLè¦ç´„', icon: 'fas fa-globe', color: 'info' }
    };
    return types[type] || { name: type || 'è¦ç´„', icon: 'fas fa-file-alt', color: 'secondary' };
}

function filterHistory() {
    const typeFilter = $('#typeFilter').val();
    const dateFilter = $('#dateFilter').val();
    const searchQuery = $('#searchInput').val().toLowerCase();
    
    filteredHistory = allHistory.filter(item => {
        // ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const itemType = item.operation_type || item.type || 'summarize';
        if (typeFilter !== 'all' && itemType !== typeFilter && 
            !(typeFilter === 'summarize' && (itemType === 'short' || itemType === 'long'))) {
            return false;
        }
        
        // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (dateFilter !== 'all') {
            const itemDate = new Date(item.created_at || item.timestamp);
            const now = new Date();
            const diffDays = (now - itemDate) / (1000 * 60 * 60 * 24);
            
            if (dateFilter === 'today' && diffDays > 1) return false;
            if (dateFilter === 'week' && diffDays > 7) return false;
            if (dateFilter === 'month' && diffDays > 30) return false;
        }
        
        // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (searchQuery) {
            const result = item.result_text || item.result || '';
            const original = item.original_text || '';
            const searchText = (result + ' ' + original).toLowerCase();
            if (!searchText.includes(searchQuery)) {
                return false;
            }
        }
        
        return true;
    });
    
    displayHistory();
}

function viewDetail(index) {
    currentDetail = filteredHistory[index];
    
    // åŸºæœ¬æƒ…å ±
    $('#modalTimestamp').text(new Date(currentDetail.created_at || currentDetail.timestamp).toLocaleString('ja-JP'));
    
    const typeInfo = getTypeInfo(currentDetail.operation_type || currentDetail.type);
    $('#modalType').html(`<i class="${typeInfo.icon} me-1"></i>${typeInfo.name}`);
    $('#modalType').removeClass().addClass(`badge bg-${typeInfo.color}`);
    
    // è¨€èªæƒ…å ±
    const sourceLang = currentDetail.source_lang || 'auto';
    const targetLang = currentDetail.target_lang || 'jpn_Jpan';
    $('#modalLanguage').text(`${formatLanguage(sourceLang)} â†’ ${formatLanguage(targetLang)}`);
    
    // å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã¨è¦ç´„çµæœ
    const original = currentDetail.original_text || '';
    const result = currentDetail.result_text || currentDetail.result || '';
    
    if (original) {
        $('#modalOriginal').show();
        $('#modalOriginalText').text(original);
        $('#modalOriginalLength').text(original.length + 'æ–‡å­—');
    } else {
        $('#modalOriginal').hide();
        $('#modalOriginalLength').text('0æ–‡å­—');
    }
    
    $('#modalResultText').text(result);
    $('#modalResultLength').text(result.length + 'æ–‡å­—');
    
    // åœ§ç¸®ç‡ã®è¨ˆç®—
    if (original.length > 0 && result.length > 0) {
        const compressionRate = Math.round((1 - result.length / original.length) * 100);
        $('#modalCompressionRate').text(`${compressionRate}% åœ§ç¸® (${original.length}æ–‡å­— â†’ ${result.length}æ–‡å­—)`);
    } else {
        $('#modalCompressionRate').text('-');
    }
    
    // å®Ÿè¡Œæ™‚é–“
    const execTime = currentDetail.execution_time || 0;
    $('#modalExecTime').text(`${Number(execTime).toFixed(2)}ç§’`);
    
    // â­ å“è³ªã‚¹ã‚³ã‚¢è¡¨ç¤º
    const qualityScore = currentDetail.quality_score || 0;
    if (qualityScore > 0) {
        const scoreColor = qualityScore >= 80 ? 'success' : qualityScore >= 60 ? 'warning' : 'secondary';
        $('#modalQualityScore').html(`<span class="badge bg-${scoreColor}">${Math.round(qualityScore)}ç‚¹</span>`);
    } else {
        $('#modalQualityScore').text('-');
    }
    
    // â­ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º
    const keywords = currentDetail.keywords || [];
    if (keywords.length > 0) {
        const keywordsHtml = keywords.map(k => 
            `<span class="badge bg-info text-dark me-1 mb-1">${escapeHtml(k)}</span>`
        ).join('');
        $('#modalKeywords').html(keywordsHtml);
        $('#modalKeywordsSection').show();
    } else {
        $('#modalKeywords').html('<span class="text-muted">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</span>');
        $('#modalKeywordsSection').show();
    }
    
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    modal.show();
}

function copyResultByIndex(index) {
    const item = filteredHistory[index];
    const result = item.result_text || item.result || '';
    navigator.clipboard.writeText(result).then(() => {
        showToast('ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
    }).catch(err => {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
    });
}

function copyModalResult() {
    const result = $('#modalResultText').text();
    navigator.clipboard.writeText(result).then(() => {
        showToast('ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
    }).catch(err => {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
    });
}

function copyModalOriginal() {
    const original = $('#modalOriginalText').text();
    if (!original) {
        showToast('âš ï¸ å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
        return;
    }
    navigator.clipboard.writeText(original).then(() => {
        showToast('ğŸ“‹ å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
    }).catch(err => {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
    });
}

function saveModalResult() {
    if (!currentDetail) return;
    
    const typeInfo = getTypeInfo(currentDetail.operation_type || currentDetail.type);
    const result = currentDetail.result_text || currentDetail.result || '';
    const original = currentDetail.original_text || '';
    const timestamp = currentDetail.created_at || currentDetail.timestamp;
    const execTime = currentDetail.execution_time || 0;
    
    const content = `${typeInfo.name}çµæœ
==========

å‡¦ç†æ—¥æ™‚: ${new Date(timestamp).toLocaleString('ja-JP')}
å‡¦ç†ã‚¿ã‚¤ãƒ—: ${typeInfo.name}
å®Ÿè¡Œæ™‚é–“: ${Number(execTime).toFixed(2)}ç§’

${original ? `å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ:
${original}

` : ''}çµæœ:
${result}
`;
    
    const blob = new Blob([content], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `recapisure_${typeInfo.name}_${new Date(timestamp).toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

function exportHistory() {
    if (allHistory.length === 0) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    let content = 'recapisure å‡¦ç†å±¥æ­´ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ\n';
    content += '==================\n';
    content += `ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}\n`;
    content += `ç·ä»¶æ•°: ${allHistory.length}ä»¶\n\n`;
    
    allHistory.forEach((item, index) => {
        const typeInfo = getTypeInfo(item.operation_type || item.type);
        const result = item.result_text || item.result || '';
        const original = item.original_text || '';
        const timestamp = item.created_at || item.timestamp;
        const execTime = item.execution_time || 0;
        
        content += `${index + 1}. ${new Date(timestamp).toLocaleString('ja-JP')}\n`;
        content += `å‡¦ç†ã‚¿ã‚¤ãƒ—: ${typeInfo.name}\n`;
        content += `å®Ÿè¡Œæ™‚é–“: ${Number(execTime).toFixed(2)}ç§’\n`;
        content += `è¨€èª: ${item.source_lang || 'auto'} â†’ ${item.target_lang || 'jpn_Jpan'}\n`;
        
        if (original) {
            content += `å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ: ${original.substring(0, 200)}${original.length > 200 ? '...' : ''}\n`;
        }
        
        content += `çµæœ: ${result.substring(0, 300)}${result.length > 300 ? '...' : ''}\n`;
        content += '\n' + '-'.repeat(50) + '\n\n';
    });
    
    const blob = new Blob([content], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `recapisure_history_${new Date().toISOString().slice(0,10)}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('ğŸ“¥ å±¥æ­´ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
}

function clearHistory() {
    if (confirm('ã™ã¹ã¦ã®å‡¦ç†å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        $.post('/api/history/clear', function(data) {
            if (data.success) {
                allHistory = [];
                filteredHistory = [];
                displayHistory();
                showToast('ğŸ—‘ï¸ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
            } else {
                alert('å±¥æ­´ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            }
        }).fail(function() {
            // APIãŒãªã„å ´åˆã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚¯ãƒªã‚¢
            allHistory = [];
            filteredHistory = [];
            displayHistory();
            showToast('ğŸ—‘ï¸ è¡¨ç¤ºå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        });
    }
}

// ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
function showToast(message, type = 'success') {
    const toastId = 'toast-' + Date.now();
    const bgMap = {
        success: 'bg-success',
        error: 'bg-danger',
        info: 'bg-info',
        warning: 'bg-warning'
    };
    
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgMap[type]} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    if (!$('#toastContainer').length) {
        $('body').append('<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11"><div id="toastContainer"></div></div>');
    }
    
    $('#toastContainer').append(toastHtml);
    const toastElement = new bootstrap.Toast(document.getElementById(toastId));
    toastElement.show();
    
    document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}
</script>
{% endblock %}