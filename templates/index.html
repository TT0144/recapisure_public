{% extends "base.html" %}

{% block title %}recapisure - é«˜æ€§èƒ½æ—¥æœ¬èªè¦ç´„ã‚µãƒ¼ãƒ“ã‚¹{% endblock %}

{% block content %}
        <div class="row">
            <div class="col-12 col-lg-10 mx-auto">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <!-- â­ æ©Ÿèƒ½é¸æŠãƒœã‚¿ãƒ³ -->
                        <div class="btn-group w-100 mb-3" role="group" aria-label="æ©Ÿèƒ½é¸æŠ">
                            <input type="radio" class="btn-check" name="featureMode" id="modeSummarize" value="summarize" checked autocomplete="off">
                            <label class="btn btn-outline-primary" for="modeSummarize">
                                <i class="fas fa-compress-alt me-1"></i>é•·æ–‡è¦ç´„
                            </label>

                            <input type="radio" class="btn-check" name="featureMode" id="modeExpand" value="expand" autocomplete="off">
                            <label class="btn btn-outline-success" for="modeExpand">
                                <i class="fas fa-expand-alt me-1"></i>çŸ­æ–‡å±•é–‹
                            </label>

                            <input type="radio" class="btn-check" name="featureMode" id="modeUrl" value="url" autocomplete="off">
                            <label class="btn btn-outline-info" for="modeUrl">
                                <i class="fas fa-globe me-1"></i>URLè¦ç´„
                            </label>
                            
                            <!-- â­ ã‚³ãƒ¼ãƒ‰è§£èª¬æ©Ÿèƒ½ã¯ä¸€æ™‚åœæ­¢
                            <input type="radio" class="btn-check" name="featureMode" id="modeCode" value="code" autocomplete="off">
                            <label class="btn btn-outline-warning" for="modeCode">
                                <i class="fas fa-code me-1"></i>ã‚³ãƒ¼ãƒ‰è§£èª¬
                            </label>
                            -->
                        </div>
                        
                        <!-- â­ URLå…¥åŠ›æ¬„ï¼ˆURLè¦ç´„ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                        <div class="mb-3" id="urlInputArea" style="display: none;">
                            <label for="urlInput" class="form-label">
                                <i class="fas fa-link me-1"></i>URL
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-globe"></i></span>
                                <input type="url" class="form-control" id="urlInput" placeholder="https://example.com/article">
                                <button class="btn btn-primary" type="button" id="fetchUrlBtn">
                                    <i class="fas fa-magic me-1"></i>è¦ç´„
                                </button>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                URLã‚’å…¥åŠ›ã—ã¦ã€Œè¦ç´„ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€è¨˜äº‹ã‚’è‡ªå‹•å–å¾—ã—ã¦è¦ç´„ã—ã¾ã™
                            </div>
                        </div>
                        
                        <!-- PDFãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
                        <div class="pdf-drop-zone mb-3" id="pdf-drop-zone">
                            <div class="drop-icon">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="drop-text">
                                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—
                            </div>
                            <div class="drop-subtext">
                                ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br>
                                <small class="text-muted">ğŸ“„ PDF, TXT ğŸ“· PNG, JPG, JPEG (èª¬æ˜æ›¸ã®å†™çœŸã‚‚OK!)</small>
                            </div>
                        </div>
                        
                        <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                        <div class="mb-4" id="textInputArea">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="inputText" class="form-label mb-0">
                                    <i class="fas fa-edit me-1"></i>å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
                                </label>
                                <span class="badge bg-secondary" id="charCounter">
                                    <i class="fas fa-text-width me-1"></i>0æ–‡å­—
                                </span>
                            </div>
                            <textarea class="form-control" id="inputText" rows="8" placeholder="ã“ã“ã«è¦ç´„ãƒ»å±•é–‹ã—ãŸã„ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                æœ€å¤§10,000æ–‡å­—ã¾ã§å¯¾å¿œã€‚PDFãƒ»ç”»åƒã¯ä¸Šã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
                            </div>
                        </div>
                        <!-- â­ è¨­å®šã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
                        <div class="accordion settings-accordion mb-4" id="settingsAccordion">
                            <!-- åŸºæœ¬è¨­å®š -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingBasicSettings">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#collapseBasicSettings" aria-expanded="true"
                                            aria-controls="collapseBasicSettings">
                                        <i class="fas fa-sliders-h me-2"></i>åŸºæœ¬è¨­å®š
                                    </button>
                                </h2>
                                <div id="collapseBasicSettings" class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <div class="row g-3">
                                            <!-- å…¥åŠ›è¨€èª -->
                                            <div class="col-md-6" id="sourceLangContainer">
                                                <label for="sourceLang" class="form-label">
                                                    <i class="fas fa-language me-1"></i>å…¥åŠ›è¨€èª
                                                </label>
                                                <select class="form-select" id="sourceLang">
                                                    <option value="auto" selected>è‡ªå‹•æ¤œå‡º</option>
                                                    
                                                <optgroup label="ä¸»è¦è¨€èª">
                                                    <option value="eng_Latn">ğŸ‡ºğŸ‡¸ è‹±èª (English)</option>
                                                    <option value="jpn_Jpan">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª (æ—¥æœ¬èª)</option>
                                                    <option value="zho_Hans">ğŸ‡¨ğŸ‡³ ä¸­å›½èªç°¡ä½“å­— (ç®€ä½“ä¸­æ–‡)</option>
                                                    <option value="zho_Hant">ğŸ‡¹ğŸ‡¼ ä¸­å›½èªç¹ä½“å­— (ç¹é«”ä¸­æ–‡)</option>
                                                    <option value="kor_Hang">ğŸ‡°ğŸ‡· éŸ“å›½èª (í•œêµ­ì–´)</option>
                                                    <option value="fra_Latn">ğŸ‡«ğŸ‡· ãƒ•ãƒ©ãƒ³ã‚¹èª (FranÃ§ais)</option>
                                                    <option value="deu_Latn">ğŸ‡©ğŸ‡ª ãƒ‰ã‚¤ãƒ„èª (Deutsch)</option>
                                                    <option value="spa_Latn">ğŸ‡ªğŸ‡¸ ã‚¹ãƒšã‚¤ãƒ³èª (EspaÃ±ol)</option>
                                                    <option value="ita_Latn">ğŸ‡®ğŸ‡¹ ã‚¤ã‚¿ãƒªã‚¢èª (Italiano)</option>
                                                    <option value="por_Latn">ğŸ‡µğŸ‡¹ ãƒãƒ«ãƒˆã‚¬ãƒ«èª (PortuguÃªs)</option>
                                                    <option value="rus_Cyrl">ğŸ‡·ğŸ‡º ãƒ­ã‚·ã‚¢èª (Ğ ÑƒÑÑĞºĞ¸Ğ¹)</option>
                                                </optgroup>
                                                
                                                <optgroup label="ã‚¢ã‚¸ã‚¢è¨€èª">
                                                    <option value="hin_Deva">ğŸ‡®ğŸ‡³ ãƒ’ãƒ³ãƒ‡ã‚£ãƒ¼èª (à¤¹à¤¿à¤¨à¥à¤¦à¥€)</option>
                                                    <option value="ben_Beng">ğŸ‡§ğŸ‡© ãƒ™ãƒ³ã‚¬ãƒ«èª (à¦¬à¦¾à¦‚à¦²à¦¾)</option>
                                                    <option value="tha_Thai">ğŸ‡¹ğŸ‡­ ã‚¿ã‚¤èª (à¹„à¸—à¸¢)</option>
                                                    <option value="vie_Latn">ğŸ‡»ğŸ‡³ ãƒ™ãƒˆãƒŠãƒ èª (Tiáº¿ng Viá»‡t)</option>
                                                    <option value="ind_Latn">ğŸ‡®ğŸ‡© ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª (Indonesia)</option>
                                                    <option value="urd_Arab">ğŸ‡µğŸ‡° ã‚¦ãƒ«ãƒ‰ã‚¥ãƒ¼èª (Ø§Ø±Ø¯Ùˆ)</option>
                                                    <option value="tel_Telu">ğŸ‡®ğŸ‡³ ãƒ†ãƒ«ã‚°èª (à°¤à±†à°²à±à°—à±)</option>
                                                    <option value="tam_Taml">ğŸ‡®ğŸ‡³ ã‚¿ãƒŸãƒ«èª (à®¤à®®à®¿à®´à¯)</option>
                                                    <option value="mar_Deva">ğŸ‡®ğŸ‡³ ãƒãƒ©ãƒ¼ãƒ†ã‚£ãƒ¼èª (à¤®à¤°à¤¾à¤ à¥€)</option>
                                                </optgroup>
                                                
                                                <optgroup label="ã‚¢ãƒ•ãƒªã‚«è¨€èª">
                                                    <option value="swh_Latn">ğŸ‡°ğŸ‡ª ã‚¹ãƒ¯ãƒ’ãƒªèª (Kiswahili)</option>
                                                    <option value="amh_Ethi">ğŸ‡ªğŸ‡¹ ã‚¢ãƒ ãƒãƒ©èª (áŠ áˆ›áˆ­áŠ›)</option>
                                                    <option value="yor_Latn">ğŸ‡³ğŸ‡¬ ãƒ¨ãƒ«ãƒèª (YorÃ¹bÃ¡)</option>
                                                    <option value="hau_Latn">ğŸ‡³ğŸ‡¬ ãƒã‚¦ã‚µèª (Hausa)</option>
                                                    <option value="som_Latn">ğŸ‡¸ğŸ‡´ ã‚½ãƒãƒªã‚¢èª (Soomaali)</option>
                                                    <option value="ibo_Latn">ğŸ‡³ğŸ‡¬ ã‚¤ãƒœèª (Igbo) â­</option>
                                                    <option value="sna_Latn">ğŸ‡¿ğŸ‡¼ ã‚·ãƒ§ãƒŠèª (chiShona) â­</option>
                                                    <option value="nso_Latn">ğŸ‡¿ğŸ‡¦ åŒ—ã‚½ãƒˆèª (Sesotho sa Leboa) â­</option>
                                                </optgroup>
                                                
                                                <optgroup label="ä¸­æ±è¨€èª">
                                                    <option value="arb_Arab">ğŸ‡¸ğŸ‡¦ ã‚¢ãƒ©ãƒ“ã‚¢èª (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</option>
                                                    <option value="pes_Arab">ğŸ‡®ğŸ‡· ãƒšãƒ«ã‚·ã‚¢èª (ÙØ§Ø±Ø³ÛŒ)</option>
                                                    <option value="tur_Latn">ğŸ‡¹ğŸ‡· ãƒˆãƒ«ã‚³èª (TÃ¼rkÃ§e)</option>
                                                    <option value="heb_Hebr">ğŸ‡®ğŸ‡± ãƒ˜ãƒ–ãƒ©ã‚¤èª (×¢×‘×¨×™×ª)</option>
                                                </optgroup>
                                                
                                                <optgroup label="ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘å°‘æ•°è¨€èª">
                                                    <option value="cat_Latn">ğŸ‡ªğŸ‡¸ ã‚«ã‚¿ãƒ«ãƒ¼ãƒ‹ãƒ£èª (CatalÃ )</option>
                                                    <option value="glg_Latn">ğŸ‡ªğŸ‡¸ ã‚¬ãƒªã‚·ã‚¢èª (Galego)</option>
                                                    <option value="eus_Latn">ğŸ‡ªğŸ‡¸ ãƒã‚¹ã‚¯èª (Euskara) â­</option>
                                                    <option value="cym_Latn">ğŸ´ ã‚¦ã‚§ãƒ¼ãƒ«ã‚ºèª (Cymraeg)</option>
                                                    <option value="gle_Latn">ğŸ‡®ğŸ‡ª ã‚¢ã‚¤ãƒ«ãƒ©ãƒ³ãƒ‰èª (Gaeilge)</option>
                                                    <option value="gla_Latn">ğŸ´ ã‚¹ã‚³ãƒƒãƒˆãƒ©ãƒ³ãƒ‰ãƒ»ã‚²ãƒ¼ãƒ«èª (GÃ idhlig) â­</option>
                                                    <option value="isl_Latn">ğŸ‡®ğŸ‡¸ ã‚¢ã‚¤ã‚¹ãƒ©ãƒ³ãƒ‰èª (Ãslenska)</option>
                                                    <option value="mlt_Latn">ğŸ‡²ğŸ‡¹ ãƒãƒ«ã‚¿èª (Malti)</option>
                                                    <option value="ltz_Latn">ğŸ‡±ğŸ‡º ãƒ«ã‚¯ã‚»ãƒ³ãƒ–ãƒ«ã‚¯èª (LÃ«tzebuergesch) â­</option>
                                                    <option value="afr_Latn">ğŸ‡¿ğŸ‡¦ ã‚¢ãƒ•ãƒªã‚«ãƒ¼ãƒ³ã‚¹èª (Afrikaans)</option>
                                                    <option value="pol_Latn">ğŸ‡µğŸ‡± ãƒãƒ¼ãƒ©ãƒ³ãƒ‰èª (Polski)</option>
                                                    <option value="ukr_Cyrl">ğŸ‡ºğŸ‡¦ ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠèª (Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°)</option>
                                                    <option value="nld_Latn">ğŸ‡³ğŸ‡± ã‚ªãƒ©ãƒ³ãƒ€èª (Nederlands)</option>
                                                    <option value="swe_Latn">ğŸ‡¸ğŸ‡ª ã‚¹ã‚¦ã‚§ãƒ¼ãƒ‡ãƒ³èª (Svenska)</option>
                                                    <option value="fin_Latn">ğŸ‡«ğŸ‡® ãƒ•ã‚£ãƒ³ãƒ©ãƒ³ãƒ‰èª (Suomi)</option>
                                                </optgroup>
                                                
                                                <optgroup label="å—ç±³å…ˆä½æ°‘èª">
                                                    <option value="que_Latn">ğŸ‡µğŸ‡ª ã‚±ãƒãƒ¥ã‚¢èª (Qhichwa) â­</option>
                                                    <option value="aym_Latn">ğŸ‡§ğŸ‡´ ã‚¢ã‚¤ãƒãƒ©èª (Aymar) â­</option>
                                                    <option value="grn_Latn">ğŸ‡µğŸ‡¾ ã‚°ã‚¢ãƒ©ãƒ‹ãƒ¼èª (GuaranÃ­) â­</option>
                                                </optgroup>
                                                
                                                <optgroup label="ä¸­å¤®ã‚¢ã‚¸ã‚¢ãƒ»ãƒãƒ™ãƒƒãƒˆæ–‡åŒ–åœ">
                                                    <option value="mon_Cyrl">ğŸ‡²ğŸ‡³ ãƒ¢ãƒ³ã‚´ãƒ«èª (ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»)</option>
                                                    <option value="bod_Tibt">ğŸ‡¨ğŸ‡³ ãƒãƒ™ãƒƒãƒˆèª (à½–à½¼à½‘à¼‹à½¡à½²à½‚) â­</option>
                                                    <option value="uig_Arab">ğŸ‡¨ğŸ‡³ ã‚¦ã‚¤ã‚°ãƒ«èª (Ø¦Û‡ÙŠØºÛ‡Ø±) â­</option>
                                                    <option value="kaz_Cyrl">ğŸ‡°ğŸ‡¿ ã‚«ã‚¶ãƒ•èª (ÒšĞ°Ğ·Ğ°Ò›)</option>
                                                    <option value="uzb_Latn">ğŸ‡ºğŸ‡¿ ã‚¦ã‚ºãƒ™ã‚¯èª (O'zbek)</option>
                                                    <option value="kir_Cyrl">ğŸ‡°ğŸ‡¬ ã‚­ãƒ«ã‚®ã‚¹èª (ĞšÑ‹Ñ€Ğ³Ñ‹Ğ·) â­</option>
                                                    <option value="tgk_Cyrl">ğŸ‡¹ğŸ‡¯ ã‚¿ã‚¸ã‚¯èª (Ğ¢Ğ¾Ò·Ğ¸ĞºÓ£) â­</option>
                                                    <option value="aze_Latn">ğŸ‡¦ğŸ‡¿ ã‚¢ã‚¼ãƒ«ãƒã‚¤ã‚¸ãƒ£ãƒ³èª (AzÉ™rbaycan)</option>
                                                    <option value="kat_Geor">ğŸ‡¬ğŸ‡ª ã‚¸ãƒ§ãƒ¼ã‚¸ã‚¢èª (áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜)</option>
                                                    <option value="hye_Armn">ğŸ‡¦ğŸ‡² ã‚¢ãƒ«ãƒ¡ãƒ‹ã‚¢èª (Õ€Õ¡ÕµÕ¥Ö€Õ¥Õ¶)</option>
                                                </optgroup>
                                                
                                                <optgroup label="ãã®ä»–ã®åœ°åŸŸè¨€èª">
                                                    <option value="mlg_Latn">ğŸ‡²ğŸ‡¬ ãƒãƒ€ã‚¬ã‚¹ã‚«ãƒ«èª (Malagasy)</option>
                                                </optgroup>
                                            </select>
                                            <div class="form-text">
                                                ã‚½ãƒ¼ã‚¹è¨€èªã‚’æŒ‡å®šã™ã‚‹ã¨ã€ç¿»è¨³ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™
                                            </div>
                                        </div>

                                        <!-- å‡ºåŠ›è¨€èª -->
                                        <div class="col-md-6">
                                            <label for="targetLang" class="form-label">
                                                <i class="fas fa-globe me-1"></i>å‡ºåŠ›è¨€èª
                                            </label>
                                            <select class="form-select" id="targetLang">
                                                <optgroup label="ä¸»è¦è¨€èª">
                                                    <option value="jpn_Jpan" selected>ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª (æ—¥æœ¬èª)</option>
                                                    <option value="eng_Latn">ğŸ‡ºğŸ‡¸ è‹±èª (English)</option>
                                                    <option value="zho_Hans">ğŸ‡¨ğŸ‡³ ä¸­å›½èªç°¡ä½“å­— (ç®€ä½“ä¸­æ–‡)</option>
                                                    <option value="zho_Hant">ğŸ‡¹ğŸ‡¼ ä¸­å›½èªç¹ä½“å­— (ç¹é«”ä¸­æ–‡)</option>
                                                    <option value="kor_Hang">ğŸ‡°ğŸ‡· éŸ“å›½èª (í•œêµ­ì–´)</option>
                                                    <option value="fra_Latn">ğŸ‡«ğŸ‡· ãƒ•ãƒ©ãƒ³ã‚¹èª (FranÃ§ais)</option>
                                                    <option value="deu_Latn">ğŸ‡©ğŸ‡ª ãƒ‰ã‚¤ãƒ„èª (Deutsch)</option>
                                                    <option value="spa_Latn">ğŸ‡ªğŸ‡¸ ã‚¹ãƒšã‚¤ãƒ³èª (EspaÃ±ol)</option>
                                                    <option value="ita_Latn">ğŸ‡®ğŸ‡¹ ã‚¤ã‚¿ãƒªã‚¢èª (Italiano)</option>
                                                    <option value="por_Latn">ğŸ‡µğŸ‡¹ ãƒãƒ«ãƒˆã‚¬ãƒ«èª (PortuguÃªs)</option>
                                                    <option value="rus_Cyrl">ğŸ‡·ğŸ‡º ãƒ­ã‚·ã‚¢èª (Ğ ÑƒÑÑĞºĞ¸Ğ¹)</option>
                                                </optgroup>
                                                
                                                <optgroup label="ã‚¢ã‚¸ã‚¢è¨€èª">
                                                    <option value="hin_Deva">ğŸ‡®ğŸ‡³ ãƒ’ãƒ³ãƒ‡ã‚£ãƒ¼èª (à¤¹à¤¿à¤¨à¥à¤¦à¥€)</option>
                                                    <option value="ben_Beng">ğŸ‡§ğŸ‡© ãƒ™ãƒ³ã‚¬ãƒ«èª (à¦¬à¦¾à¦‚à¦²à¦¾)</option>
                                                    <option value="tha_Thai">ğŸ‡¹ğŸ‡­ ã‚¿ã‚¤èª (à¹„à¸—à¸¢)</option>
                                                    <option value="vie_Latn">ğŸ‡»ğŸ‡³ ãƒ™ãƒˆãƒŠãƒ èª (Tiáº¿ng Viá»‡t)</option>
                                                    <option value="ind_Latn">ğŸ‡®ğŸ‡© ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª (Indonesia)</option>
                                                    <option value="urd_Arab">ğŸ‡µğŸ‡° ã‚¦ãƒ«ãƒ‰ã‚¥ãƒ¼èª (Ø§Ø±Ø¯Ùˆ)</option>
                                                    <option value="tel_Telu">ğŸ‡®ğŸ‡³ ãƒ†ãƒ«ã‚°èª (à°¤à±†à°²à±à°—à±)</option>
                                                    <option value="tam_Taml">ğŸ‡®ğŸ‡³ ã‚¿ãƒŸãƒ«èª (à®¤à®®à®¿à®´à¯)</option>
                                                    <option value="mar_Deva">ğŸ‡®ğŸ‡³ ãƒãƒ©ãƒ¼ãƒ†ã‚£ãƒ¼èª (à¤®à¤°à¤¾à¤ à¥€)</option>
                                                </optgroup>
                                                
                                                <optgroup label="ã‚¢ãƒ•ãƒªã‚«è¨€èª">
                                                    <option value="swh_Latn">ğŸ‡°ğŸ‡ª ã‚¹ãƒ¯ãƒ’ãƒªèª (Kiswahili)</option>
                                                    <option value="amh_Ethi">ğŸ‡ªğŸ‡¹ ã‚¢ãƒ ãƒãƒ©èª (áŠ áˆ›áˆ­áŠ›)</option>
                                                    <option value="yor_Latn">ğŸ‡³ğŸ‡¬ ãƒ¨ãƒ«ãƒèª (YorÃ¹bÃ¡)</option>
                                                    <option value="hau_Latn">ğŸ‡³ğŸ‡¬ ãƒã‚¦ã‚µèª (Hausa)</option>
                                                    <option value="som_Latn">ğŸ‡¸ğŸ‡´ ã‚½ãƒãƒªã‚¢èª (Soomaali)</option>
                                                    <option value="ibo_Latn">ğŸ‡³ğŸ‡¬ ã‚¤ãƒœèª (Igbo) â­</option>
                                                    <option value="sna_Latn">ğŸ‡¿ğŸ‡¼ ã‚·ãƒ§ãƒŠèª (chiShona) â­</option>
                                                    <option value="nso_Latn">ğŸ‡¿ğŸ‡¦ åŒ—ã‚½ãƒˆèª (Sesotho sa Leboa) â­</option>
                                                </optgroup>
                                                
                                                <optgroup label="ä¸­æ±è¨€èª">
                                                    <option value="arb_Arab">ğŸ‡¸ğŸ‡¦ ã‚¢ãƒ©ãƒ“ã‚¢èª (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</option>
                                                    <option value="pes_Arab">ğŸ‡®ğŸ‡· ãƒšãƒ«ã‚·ã‚¢èª (ÙØ§Ø±Ø³ÛŒ)</option>
                                                    <option value="tur_Latn">ğŸ‡¹ğŸ‡· ãƒˆãƒ«ã‚³èª (TÃ¼rkÃ§e)</option>
                                                    <option value="heb_Hebr">ğŸ‡®ğŸ‡± ãƒ˜ãƒ–ãƒ©ã‚¤èª (×¢×‘×¨×™×ª)</option>
                                                </optgroup>
                                                
                                                <optgroup label="ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘å°‘æ•°è¨€èª">
                                                    <option value="cat_Latn">ğŸ‡ªğŸ‡¸ ã‚«ã‚¿ãƒ«ãƒ¼ãƒ‹ãƒ£èª (CatalÃ )</option>
                                                    <option value="glg_Latn">ğŸ‡ªğŸ‡¸ ã‚¬ãƒªã‚·ã‚¢èª (Galego)</option>
                                                    <option value="eus_Latn">ğŸ‡ªğŸ‡¸ ãƒã‚¹ã‚¯èª (Euskara) â­</option>
                                                    <option value="cym_Latn">ğŸ´ ã‚¦ã‚§ãƒ¼ãƒ«ã‚ºèª (Cymraeg)</option>
                                                    <option value="gle_Latn">ğŸ‡®ğŸ‡ª ã‚¢ã‚¤ãƒ«ãƒ©ãƒ³ãƒ‰èª (Gaeilge)</option>
                                                    <option value="gla_Latn">ğŸ´ ã‚¹ã‚³ãƒƒãƒˆãƒ©ãƒ³ãƒ‰ãƒ»ã‚²ãƒ¼ãƒ«èª (GÃ idhlig) â­</option>
                                                    <option value="isl_Latn">ğŸ‡®ğŸ‡¸ ã‚¢ã‚¤ã‚¹ãƒ©ãƒ³ãƒ‰èª (Ãslenska)</option>
                                                    <option value="mlt_Latn">ğŸ‡²ğŸ‡¹ ãƒãƒ«ã‚¿èª (Malti)</option>
                                                    <option value="ltz_Latn">ğŸ‡±ğŸ‡º ãƒ«ã‚¯ã‚»ãƒ³ãƒ–ãƒ«ã‚¯èª (LÃ«tzebuergesch) â­</option>
                                                    <option value="afr_Latn">ğŸ‡¿ğŸ‡¦ ã‚¢ãƒ•ãƒªã‚«ãƒ¼ãƒ³ã‚¹èª (Afrikaans)</option>
                                                    <option value="pol_Latn">ğŸ‡µğŸ‡± ãƒãƒ¼ãƒ©ãƒ³ãƒ‰èª (Polski)</option>
                                                    <option value="ukr_Cyrl">ğŸ‡ºğŸ‡¦ ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠèª (Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°)</option>
                                                    <option value="nld_Latn">ğŸ‡³ğŸ‡± ã‚ªãƒ©ãƒ³ãƒ€èª (Nederlands)</option>
                                                    <option value="swe_Latn">ğŸ‡¸ğŸ‡ª ã‚¹ã‚¦ã‚§ãƒ¼ãƒ‡ãƒ³èª (Svenska)</option>
                                                    <option value="fin_Latn">ğŸ‡«ğŸ‡® ãƒ•ã‚£ãƒ³ãƒ©ãƒ³ãƒ‰èª (Suomi)</option>
                                                </optgroup>
                                                
                                                <optgroup label="å—ç±³å…ˆä½æ°‘èª">
                                                    <option value="que_Latn">ğŸ‡µğŸ‡ª ã‚±ãƒãƒ¥ã‚¢èª (Qhichwa) â­</option>
                                                    <option value="aym_Latn">ğŸ‡§ğŸ‡´ ã‚¢ã‚¤ãƒãƒ©èª (Aymar) â­</option>
                                                    <option value="grn_Latn">ğŸ‡µğŸ‡¾ ã‚°ã‚¢ãƒ©ãƒ‹ãƒ¼èª (GuaranÃ­) â­</option>
                                                </optgroup>
                                                
                                                <optgroup label="ä¸­å¤®ã‚¢ã‚¸ã‚¢ãƒ»ãƒãƒ™ãƒƒãƒˆæ–‡åŒ–åœ">
                                                    <option value="mon_Cyrl">ğŸ‡²ğŸ‡³ ãƒ¢ãƒ³ã‚´ãƒ«èª (ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»)</option>
                                                    <option value="bod_Tibt">ğŸ‡¨ğŸ‡³ ãƒãƒ™ãƒƒãƒˆèª (à½–à½¼à½‘à¼‹à½¡à½²à½‚) â­</option>
                                                    <option value="uig_Arab">ğŸ‡¨ğŸ‡³ ã‚¦ã‚¤ã‚°ãƒ«èª (Ø¦Û‡ÙŠØºÛ‡Ø±) â­</option>
                                                    <option value="kaz_Cyrl">ğŸ‡°ğŸ‡¿ ã‚«ã‚¶ãƒ•èª (ÒšĞ°Ğ·Ğ°Ò›)</option>
                                                    <option value="uzb_Latn">ğŸ‡ºğŸ‡¿ ã‚¦ã‚ºãƒ™ã‚¯èª (O'zbek)</option>
                                                    <option value="kir_Cyrl">ğŸ‡°ğŸ‡¬ ã‚­ãƒ«ã‚®ã‚¹èª (ĞšÑ‹Ñ€Ğ³Ñ‹Ğ·) â­</option>
                                                    <option value="tgk_Cyrl">ğŸ‡¹ğŸ‡¯ ã‚¿ã‚¸ã‚¯èª (Ğ¢Ğ¾Ò·Ğ¸ĞºÓ£) â­</option>
                                                    <option value="aze_Latn">ğŸ‡¦ğŸ‡¿ ã‚¢ã‚¼ãƒ«ãƒã‚¤ã‚¸ãƒ£ãƒ³èª (AzÉ™rbaycan)</option>
                                                    <option value="kat_Geor">ğŸ‡¬ğŸ‡ª ã‚¸ãƒ§ãƒ¼ã‚¸ã‚¢èª (áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜)</option>
                                                    <option value="hye_Armn">ğŸ‡¦ğŸ‡² ã‚¢ãƒ«ãƒ¡ãƒ‹ã‚¢èª (Õ€Õ¡ÕµÕ¥Ö€Õ¥Õ¶)</option>
                                                </optgroup>
                                                
                                                <optgroup label="ãã®ä»–ã®åœ°åŸŸè¨€èª">
                                                    <option value="mlg_Latn">ğŸ‡²ğŸ‡¬ ãƒãƒ€ã‚¬ã‚¹ã‚«ãƒ«èª (Malagasy)</option>
                                                </optgroup>
                                            </select>
                                            <div class="form-text">
                                                è¦ç´„çµæœã®è¨€èªã‚’é¸æŠï¼ˆ70ä»¥ä¸Šã®è¨€èªã«å¯¾å¿œã€â­ã¯Googleç¿»è¨³éå¯¾å¿œè¨€èªï¼‰
                                            </div>
                                        </div>

                                        <!-- è¦ç´„ãƒ¢ãƒ¼ãƒ‰ï¼ˆé•·æ–‡è¦ç´„æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                                        <div class="col-md-6" id="summaryLengthContainer">
                                            <label for="summaryLength" class="form-label">
                                                <i class="fas fa-compress-alt me-1"></i>è¦ç´„ãƒ¢ãƒ¼ãƒ‰
                                            </label>
                                            <select class="form-select" id="summaryLength">
                                                <option value="short" selected>é€šå¸¸è¦ç´„ (300-600å­—ç¨‹åº¦)</option>
                                                <option value="long">è©³ç´°è¦ç´„ (600-1000å­—ç¨‹åº¦)</option>
                                            </select>
                                            <small class="text-muted">
                                                â€»å…¥åŠ›æ–‡ç« ã®é•·ã•ã«ã‚ˆã‚Šå¤‰å‹•ã—ã¾ã™
                                            </small>
                                        </div>
                                        
                                        <!-- å±•é–‹ãƒ¢ãƒ¼ãƒ‰ï¼ˆçŸ­æ–‡å±•é–‹æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                                        <div class="col-md-6" id="expandLengthContainer" style="display: none;">
                                            <label for="expandLength" class="form-label">
                                                <i class="fas fa-expand-alt me-1"></i>å±•é–‹ãƒ¢ãƒ¼ãƒ‰
                                            </label>
                                            <select class="form-select" id="expandLength">
                                                <option value="300">ç°¡æ˜“å±•é–‹ (300å­—ç¨‹åº¦)</option>
                                                <option value="500" selected>æ¨™æº–å±•é–‹ (500å­—ç¨‹åº¦)</option>
                                                <option value="800">è©³ç´°å±•é–‹ (800å­—ç¨‹åº¦)</option>
                                            </select>
                                            <small class="text-muted">
                                                â€»å…¥åŠ›ã¯100æ–‡å­—ä»¥å†…ãŒæ¨å¥¨ã§ã™
                                            </small>
                                        </div>
                                        
                                        <!-- ã‚³ãƒ¼ãƒ‰è¨€èªé¸æŠï¼ˆã‚³ãƒ¼ãƒ‰è§£èª¬æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                                        <div class="col-md-6" id="codeLangContainer" style="display: none;">
                                            <label for="codeLang" class="form-label">
                                                <i class="fas fa-code me-1"></i>ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª
                                            </label>
                                            <select class="form-select" id="codeLang">
                                                <option value="auto" selected>è‡ªå‹•æ¤œå‡º</option>
                                                <option value="Python">Python</option>
                                                <option value="JavaScript">JavaScript</option>
                                                <option value="TypeScript">TypeScript</option>
                                                <option value="Java">Java</option>
                                                <option value="C">C</option>
                                                <option value="C++">C++</option>
                                                <option value="C#">C#</option>
                                                <option value="Go">Go</option>
                                                <option value="Rust">Rust</option>
                                                <option value="Ruby">Ruby</option>
                                                <option value="PHP">PHP</option>
                                                <option value="Swift">Swift</option>
                                                <option value="Kotlin">Kotlin</option>
                                                <option value="SQL">SQL</option>
                                                <option value="HTML/CSS">HTML/CSS</option>
                                                <option value="Shell">Shell/Bash</option>
                                            </select>
                                            <small class="text-muted">
                                                â€»ã‚ã‹ã‚‰ãªã‘ã‚Œã°ã€Œè‡ªå‹•æ¤œå‡ºã€ã§OK
                                            </small>
                                        </div>

                                        <!-- è¦ç´„ã‚¹ã‚¿ã‚¤ãƒ« -->
                                        <div class="col-md-6">
                                            <label for="summaryStyle" class="form-label">
                                                <i class="fas fa-palette me-1"></i>è¦ç´„ã‚¹ã‚¿ã‚¤ãƒ«
                                            </label>
                                            <select class="form-select" id="summaryStyle">
                                                <option value="balanced" selected>ãƒãƒ©ãƒ³ã‚¹å‹ï¼ˆæ–‡ç« å½¢å¼ï¼‰</option>
                                                <option value="bullet">ç®‡æ¡æ›¸ãå‹</option>
                                            </select>
                                            <small class="text-muted">
                                                â€»ç®‡æ¡æ›¸ãã¯ç™ºè¡¨ãƒ»ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã«æœ€é©
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
                    <div class="d-grid">
                        <button type="button" class="btn btn-primary btn-lg" id="processBtn">
                            <i class="fas fa-play me-2"></i>
                            <span id="process-text">è¦ç´„å®Ÿè¡Œ</span>
                        </button>
                    </div>
                    
                    <!-- â­ é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°) -->
                    <div class="mt-3" id="progressArea" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>
                                        <span id="progressMessage">å‡¦ç†ä¸­...</span>
                                    </span>
                                    <span class="badge bg-primary" id="progressPercent">0%</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         id="progressBar" 
                                         role="progressbar" 
                                         style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="card shadow-sm mt-4" id="resultCard" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="result-title">å‡¦ç†çµæœ</span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- çµ±è¨ˆæƒ…å ± -->
                    <div class="row mb-3" id="stats">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-muted mb-1">å®Ÿè¡Œæ™‚é–“</h6>
                                <span class="h5" id="executionTime">-</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-muted mb-1">å…ƒã®æ–‡å­—æ•°</h6>
                                <span class="h5" id="originalLength">-</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-muted mb-1">çµæœæ–‡å­—æ•°</h6>
                                <span class="h5" id="resultLength">-</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-muted mb-1">æ¯”ç‡</h6>
                                <span class="h5" id="ratio">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- çµæœãƒ†ã‚­ã‚¹ãƒˆ -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-file-text me-1"></i>
                            <span id="result-label">å‡¦ç†çµæœ</span>
                        </label>
                        <div class="form-control" id="resultText" style="min-height: 100px; background-color: #f8f9fa; white-space: pre-wrap; line-height: 1.8;"></div>
                    </div>
                    
                    <!-- â­ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div class="mb-3" id="keywordsArea" style="display: none;">
                        <label class="form-label">
                            <i class="fas fa-tags me-1"></i>æŠ½å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                        </label>
                        <div id="keywordsContainer" class="d-flex flex-wrap gap-2">
                            <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚¸ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                        </div>
                    </div>

                    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="row g-2">
                        <div class="col-md-8">
                            <button class="btn btn-primary w-100" onclick="copyResult()">
                                <i class="fas fa-copy me-1"></i>
                                <span id="copyBtnText">çµæœã‚’ã‚³ãƒ”ãƒ¼</span>
                            </button>
                        </div>
                        <div class="col-md-4">
                            <div class="dropdown w-100">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-download me-1"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportAs('txt'); return false;">
                                        <i class="fas fa-file-alt me-2"></i>ãƒ†ã‚­ã‚¹ãƒˆ (.txt)
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportAs('md'); return false;">
                                        <i class="fab fa-markdown me-2"></i>Markdown (.md)
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportAs('html'); return false;">
                                        <i class="fab fa-html5 me-2"></i>HTML (.html)
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportAs('json'); return false;">
                                        <i class="fas fa-code me-2"></i>JSON (.json)
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-12">
                            <button class="btn btn-success w-100" onclick="newProcess()">
                                <i class="fas fa-plus me-1"></i>æ–°ã—ã„å‡¦ç†
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- èª­ã¿è¾¼ã¿ä¸­ -->
            <div class="card shadow-sm mt-4 fade-in" id="loadingCard" style="display: none;">
                <div class="card-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">å‡¦ç†ä¸­...</span>
                    </div>
                    <h5 class="text-muted" id="loading-title">å‡¦ç†ä¸­...</h5>
                    <p class="text-muted mb-3" id="loading-description">æ–‡ç« ã‚’å‡¦ç†ã—ã¦ã„ã¾ã™</p>
                    
                    <!-- çµŒéæ™‚é–“è¡¨ç¤º -->
                    <div class="mb-3">
                        <span class="badge bg-secondary fs-5 px-4 py-2" id="elapsedTimeDisplay">
                            <i class="fas fa-clock me-2"></i><span id="elapsedTime">0</span>ç§’çµŒé
                        </span>
                    </div>
                    
                    <!-- å‡¦ç†é€²æ—ãƒãƒ¼ -->
                    <div class="progress mb-3" style="height: 28px; border-radius: 14px; background: #e9ecef; border: 1px solid #dee2e6;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: 100%; background: #0066cc; font-weight: 500; font-size: 14px; border-radius: 12px;">
                            <span id="progressText" style="color: white;">å‡¦ç†ä¸­...</span>
                        </div>
                    </div>
                    
                    <!-- â­ å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—è©³ç´°è¡¨ç¤º -->
                    <div class="processing-steps text-start mx-auto" style="max-width: 400px;">
                        <div class="step-item mb-2" id="step-analyze">
                            <i class="fas fa-circle-notch fa-spin text-muted me-2" id="step-analyze-icon"></i>
                            <span class="text-muted" id="step-analyze-text">ãƒ†ã‚­ã‚¹ãƒˆåˆ†æä¸­...</span>
                        </div>
                        <div class="step-item mb-2" id="step-translate" style="display: none;">
                            <i class="fas fa-circle text-muted me-2" id="step-translate-icon"></i>
                            <span class="text-muted" id="step-translate-text">ç¿»è¨³å‡¦ç†å¾…æ©Ÿä¸­</span>
                        </div>
                        <div class="step-item mb-2" id="step-summarize" style="display: none;">
                            <i class="fas fa-circle text-muted me-2" id="step-summarize-icon"></i>
                            <span class="text-muted" id="step-summarize-text">è¦ç´„ç”Ÿæˆå¾…æ©Ÿä¸­</span>
                        </div>
                        <div class="step-item mb-2" id="step-format" style="display: none;">
                            <i class="fas fa-circle text-muted me-2" id="step-format-icon"></i>
                            <span class="text-muted" id="step-format-text">çµæœæ•´å½¢å¾…æ©Ÿä¸­</span>
                        </div>
                    </div>
                    
                    <!-- å‡¦ç†è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                    <p class="text-muted small mt-3 mb-0" id="processing-detail">
                        AIãŒæ–‡ç« ã‚’ç†è§£ã—ã¦ã„ã¾ã™...
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚¨ãƒªã‚¢ -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toastContainer"></div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentMode = 'summarize';
// â­ Socket.IOã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶š
let socket = null;
let currentTaskId = null;

$(document).ready(function() {
    // â­ Socket.IOæ¥ç¶šã‚’åˆæœŸåŒ–
    initializeSocket();
    
    // â­ è¨€èªè¨­å®šã‚’å¾©å…ƒ
    restoreLanguageSettings();
    
    // åˆæœŸè¨­å®š
    updateModeDisplay();
    updateStats();
    
    // â­ æ©Ÿèƒ½ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    $('input[name="featureMode"]').change(function() {
        currentMode = $(this).val();
        console.log('ğŸ”„ ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ:', currentMode);
        updateModeDisplay();
    });
    
    // â­ æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
    $('#inputText').on('input', function() {
        const length = $(this).val().length;
        const maxChars = currentMode === 'expand' || currentMode === 'code' ? 5000 : 10000;
        const percent = (length / maxChars * 100).toFixed(0);
        
        let badgeClass = 'bg-secondary';
        if (percent > 90) badgeClass = 'bg-danger';
        else if (percent > 70) badgeClass = 'bg-warning';
        
        $('#charCounter')
            .removeClass('bg-secondary bg-warning bg-danger')
            .addClass(badgeClass)
            .html(`<i class="fas fa-text-width me-1"></i>${length.toLocaleString()}æ–‡å­— (${percent}%)`);
    });
    
    // â­ URLå–å¾—ãƒœã‚¿ãƒ³
    $('#fetchUrlBtn').click(handleUrlFetch);
    
    // â­ è¨€èªå¤‰æ›´æ™‚ã«ä¿å­˜
    $('#sourceLang, #targetLang, #summaryStyle, #summaryLength').change(function() {
        saveLanguageSettings();
    });
    
    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
    $('#inputText').on('input', function() {
        const text = $(this).val();
        $('#charCount').text(text.length);
        
        if (text.length > 9000) {
            $('#charCount').addClass('text-warning');
        } else if (text.length > 9500) {
            $('#charCount').addClass('text-danger');
        } else {
            $('#charCount').removeClass('text-warning text-danger');
        }
    });
    
    // â­ Select2ã§è¨€èªé¸æŠã‚’æ¤œç´¢å¯èƒ½ã«ã™ã‚‹
    $('#sourceLang, #targetLang').select2({
        theme: 'bootstrap-5',
        placeholder: 'è¨€èªã‚’æ¤œç´¢...',
        allowClear: false,
        width: '100%',
        language: {
            noResults: function() {
                return "è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
            },
            searching: function() {
                return "æ¤œç´¢ä¸­...";
            }
        }
    });
    
    // Select2ã®å¤‰æ›´æ™‚ã«è¨­å®šã‚’ä¿å­˜
    $('#sourceLang, #targetLang').on('change', function() {
        saveLanguageSettings();
    });
    
    // â­ å‡¦ç†å®Ÿè¡Œï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è¦ç´„ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ï¼‰
    $('#processBtn').click(function() {
        const summaryMode = $('#summaryLength').val(); // 'short' or 'long'
        handleProcess(summaryMode);
    });
});

// â­ Socket.IOæ¥ç¶šã‚’åˆæœŸåŒ–
function initializeSocket() {
    try {
        socket = io({
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: 5
        });
        
        socket.on('connect', function() {
            console.log('ğŸ”Œ Socket.IOæ¥ç¶šæˆåŠŸ');
        });
        
        socket.on('disconnect', function() {
            console.log('ğŸ”Œ Socket.IOæ¥ç¶šåˆ‡æ–­');
        });
        
        // â­ é€²æ—æ›´æ–°ã‚’å—ä¿¡
        socket.on('progress_update', function(data) {
            console.log('ğŸ“¡ é€²æ—æ›´æ–°å—ä¿¡:', data);
            updateProgressUI(data);
        });
        
        socket.on('connect_error', function(error) {
            console.error('Socket.IOæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
        });
    } catch (e) {
        console.error('Socket.IOåˆæœŸåŒ–å¤±æ•—:', e);
    }
}

// â­ é€²æ—UIã‚’æ›´æ–°
function updateProgressUI(data) {
    // ã‚¿ã‚¹ã‚¯IDãŒä¸€è‡´ã™ã‚‹å ´åˆã®ã¿æ›´æ–°
    if (currentTaskId && data.task_id !== currentTaskId) {
        return;
    }
    
    const progressArea = $('#progressArea');
    const progressBar = $('#progressBar');
    const progressPercent = $('#progressPercent');
    const progressMessage = $('#progressMessage');
    
    // é€²æ—ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
    progressArea.show();
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
    progressBar.css('width', data.progress + '%');
    progressPercent.text(data.progress + '%');
    progressMessage.text(data.message);
    
    // ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´
    const icons = {
        'validate': 'fa-check-circle',
        'prepare': 'fa-cog',
        'summarize': 'fa-magic',
        'translate': 'fa-language',
        'process': 'fa-tasks',
        'evaluate': 'fa-chart-line',
        'save': 'fa-database',
        'complete': 'fa-check'
    };
    
    const icon = icons[data.stage] || 'fa-spinner fa-spin';
    progressMessage.html(`<i class="fas ${icon} me-2"></i>${data.message}`);
    
    // å®Œäº†æ™‚ã®å‡¦ç†
    if (data.progress >= 100 || data.stage === 'complete') {
        setTimeout(function() {
            progressArea.fadeOut();
            currentTaskId = null;
        }, 2000);
    }
}

// â­ è¨€èªè¨­å®šã‚’ä¿å­˜
function saveLanguageSettings() {
    const settings = {
        sourceLang: $('#sourceLang').val(),
        targetLang: $('#targetLang').val(),
        summaryStyle: $('#summaryStyle').val(),
        summaryLength: $('#summaryLength').val()
    };
    localStorage.setItem('languageSettings', JSON.stringify(settings));
    console.log('ğŸ’¾ è¨€èªè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ:', settings);
}

// â­ è¨€èªè¨­å®šã‚’å¾©å…ƒ
function restoreLanguageSettings() {
    const savedSettings = localStorage.getItem('languageSettings');
    if (savedSettings) {
        try {
            const settings = JSON.parse(savedSettings);
            if (settings.sourceLang) $('#sourceLang').val(settings.sourceLang);
            if (settings.targetLang) $('#targetLang').val(settings.targetLang);
            if (settings.summaryStyle) $('#summaryStyle').val(settings.summaryStyle);
            if (settings.summaryLength) $('#summaryLength').val(settings.summaryLength);
            console.log('âœ… è¨€èªè¨­å®šã‚’å¾©å…ƒã—ã¾ã—ãŸ:', settings);
        } catch (e) {
            console.error('è¨€èªè¨­å®šã®å¾©å…ƒã«å¤±æ•—:', e);
        }
    }
}

function updateModeDisplay() {
    const modes = {
        summarize: {
            title: 'é•·æ–‡è¦ç´„',
            description: 'è‡ªå‹•è¦ç´„ã‚µãƒ¼ãƒ“ã‚¹',
            inputLabel: 'è¦ç´„å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆ',
            processText: 'è¦ç´„å®Ÿè¡Œ',
            resultTitle: 'è¦ç´„çµæœ',
            resultLabel: 'ç”Ÿæˆã•ã‚ŒãŸè¦ç´„',
            loadingTitle: 'è¦ç´„ç”Ÿæˆä¸­...',
            loadingDesc: 'æ–‡ç« ã‚’åˆ†æã—ã¦ã„ã¾ã™',
            maxChars: 10000
        },
        expand: {
            title: 'çŸ­æ–‡å±•é–‹ã‚µãƒ¼ãƒ“ã‚¹',
            description: 'çŸ­æ–‡ã‚’è©³ç´°ã§è±Šã‹ãªè¡¨ç¾ã«å±•é–‹',
            inputLabel: 'å±•é–‹å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆï¼ˆçŸ­æ–‡ï¼‰',
            processText: 'æ–‡ç« å±•é–‹',
            resultTitle: 'å±•é–‹çµæœ',
            resultLabel: 'å±•é–‹ã•ã‚ŒãŸæ–‡ç« ',
            loadingTitle: 'æ–‡ç« å±•é–‹ä¸­...',
            loadingDesc: 'æ–‡ç« ã‚’è©³ç´°åŒ–ã—ã¦ã„ã¾ã™',
            maxChars: 5000
        },
        url: {
            title: 'URLè¨˜äº‹è¦ç´„',
            description: 'Webè¨˜äº‹ã‚’è‡ªå‹•å–å¾—ã—ã¦è¦ç´„',
            inputLabel: 'è¨˜äº‹å†…å®¹ï¼ˆè‡ªå‹•å–å¾—ï¼‰',
            processText: 'URLè¦ç´„',
            resultTitle: 'è¨˜äº‹è¦ç´„çµæœ',
            resultLabel: 'ç”Ÿæˆã•ã‚ŒãŸè¦ç´„',
            loadingTitle: 'è¨˜äº‹è¦ç´„ä¸­...',
            loadingDesc: 'Webè¨˜äº‹ã‚’å–å¾—ã—ã¦è¦ç´„ã—ã¦ã„ã¾ã™',
            maxChars: 10000
        }
        /* â­ ã‚³ãƒ¼ãƒ‰è§£èª¬æ©Ÿèƒ½ã¯ä¸€æ™‚åœæ­¢
        ,code: {
            title: 'ã‚³ãƒ¼ãƒ‰è§£èª¬',
            description: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚³ãƒ¼ãƒ‰ã‚’ã‚ã‹ã‚Šã‚„ã™ãè§£èª¬',
            inputLabel: 'è§£èª¬å¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰',
            processText: 'ã‚³ãƒ¼ãƒ‰è§£èª¬',
            resultTitle: 'ã‚³ãƒ¼ãƒ‰è§£èª¬çµæœ',
            resultLabel: 'ç”Ÿæˆã•ã‚ŒãŸè§£èª¬',
            loadingTitle: 'ã‚³ãƒ¼ãƒ‰è§£èª¬ä¸­...',
            loadingDesc: 'ã‚³ãƒ¼ãƒ‰ã‚’åˆ†æã—ã¦ã„ã¾ã™',
            maxChars: 5000
        }
        */
    };
    
    const mode = modes[currentMode];
    
    console.log('ğŸ“± updateModeDisplay:', currentMode, mode);
    
    // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
    $('#process-text').text(mode.processText);
    $('#result-title').text(mode.resultTitle);
    $('#result-label').text(mode.resultLabel);  // â­ çµæœãƒ©ãƒ™ãƒ«ã‚‚æ›´æ–°
    
    // â­ è¦ç´„ãƒ¢ãƒ¼ãƒ‰/å±•é–‹ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
    if (currentMode === 'expand') {
        // çŸ­æ–‡å±•é–‹ãƒ¢ãƒ¼ãƒ‰
        $('#summaryLengthContainer').hide();
        $('#expandLengthContainer').show();
        $('#codeLangContainer').hide();
        $('#summaryStyle').closest('.col-md-6').hide();
        $('#sourceLangContainer').show(); // å…¥åŠ›è¨€èªè¡¨ç¤º
    /* â­ ã‚³ãƒ¼ãƒ‰è§£èª¬æ©Ÿèƒ½ã¯ä¸€æ™‚åœæ­¢
    } else if (currentMode === 'code') {
        // ã‚³ãƒ¼ãƒ‰è§£èª¬ãƒ¢ãƒ¼ãƒ‰
        $('#summaryLengthContainer').hide();
        $('#expandLengthContainer').hide();
        $('#codeLangContainer').show();
        $('#summaryStyle').closest('.col-md-6').hide();
        $('#sourceLangContainer').hide(); // â­ å…¥åŠ›è¨€èªéè¡¨ç¤ºï¼ˆè‡ªå‹•æ¤œå‡ºï¼‰
    */
    } else if (currentMode === 'url') {
        // URLè¦ç´„ãƒ¢ãƒ¼ãƒ‰ - å…¥åŠ›è¨€èªã¯è‡ªå‹•æ¤œå‡º
        $('#summaryLengthContainer').show();
        $('#expandLengthContainer').hide();
        $('#codeLangContainer').hide();
        $('#summaryStyle').closest('.col-md-6').show();
        $('#sourceLangContainer').hide(); // â­ URLè¦ç´„ã¯è¨€èªè‡ªå‹•æ¤œå‡º
    } else {
        // é•·æ–‡è¦ç´„ãƒ¢ãƒ¼ãƒ‰
        $('#summaryLengthContainer').show();
        $('#expandLengthContainer').hide();
        $('#codeLangContainer').hide();
        $('#summaryStyle').closest('.col-md-6').show();
        $('#sourceLangContainer').show(); // å…¥åŠ›è¨€èªè¡¨ç¤º
    }
    
    // â­ å…¥åŠ›ãƒ©ãƒ™ãƒ«æ›´æ–°
    $('label[for="inputText"]').html('<i class="fas fa-edit me-1"></i>' + mode.inputLabel);
    
    // è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    if (currentMode === 'url') {
        console.log('ğŸŒ URLè¦ç´„ãƒ¢ãƒ¼ãƒ‰ - URLæ¬„è¡¨ç¤ºã€PDFã¨ãƒ†ã‚­ã‚¹ãƒˆéè¡¨ç¤º');
        $('#urlInputArea').show();
        $('#pdf-drop-zone').hide();
        $('#textInputArea').hide(); // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å…¨ä½“ã‚’éè¡¨ç¤º
        $('#processBtn').hide(); // URLè¦ç´„ã¯URLæ¬„ã®ã€Œè¦ç´„ã€ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨
    } else {
        console.log('é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ - PDFã¨ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã€URLæ¬„éè¡¨ç¤º');
        $('#urlInputArea').hide();
        $('#pdf-drop-zone').show();
        $('#textInputArea').show(); // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å…¨ä½“ã‚’è¡¨ç¤º
        $('#processBtn').show(); // è¦ç´„å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    }
}

function handleFileUpload() {
    const fileInput = $('#fileInput')[0];
    if (!fileInput.files[0]) {
        showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    $.ajax({
        url: '/api/upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                $('#inputText').val(response.text);
                $('#charCount').text(response.text.length);
                alert(`ãƒ•ã‚¡ã‚¤ãƒ« "${response.filename}" ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + response.error);
            }
        },
        error: function() {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    });
}

function handleUrlFetch() {
    const url = $('#urlInput').val().trim();
    if (!url) {
        showToast('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
    }

    $('#fetchUrlBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>å–å¾—ä¸­...');
    
    // â­ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
    $('#loadingCard').show();
    $('#resultCard').hide();
    
    // â­ é€²æ—è¡¨ç¤ºã‚’é–‹å§‹
    $('#progressArea').show();
    $('#progressBar').css('width', '0%');
    $('#progressPercent').text('0%');
    $('#progressMessage').html('<i class="fas fa-spinner fa-spin me-2"></i>URLã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ä¸­...');
    
    // â­ é€²æ—ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
    startProgressSimulation();

    // â­ URLè¦ç´„ã‚’å®Ÿè¡Œï¼ˆå–å¾—ã¨è¦ç´„ã‚’ä¸€åº¦ã«è¡Œã†ï¼‰
    $.post('/api/url-summarize', { 
        url: url, 
        summary_mode: $('#summaryLength').val() || 'short',
        source_lang: $('#sourceLang').val() || 'auto',
        target_lang: $('#targetLang').val() || 'jpn_Jpan',
        style: $('#summaryStyle').val() || 'balanced'
    })
        .done(function(response) {
            // â­ é€²æ—ãƒãƒ¼å®Œäº†
            completeProgress();
            
            if (response.success) {
                // â­ çµæœã‚’ç›´æ¥è¡¨ç¤º
                displayResult({
                    success: true,
                    summary: response.summary,
                    original_length: response.original_length,
                    summary_length: response.summary_length,
                    compression_ratio: response.compression_ratio,
                    execution_time: response.execution_time,
                    model_used: response.model_used,
                    quality_score: response.confidence * 100,
                    title: response.title
                });
                showToast('âœ… URLè¨˜äº‹ã‚’è¦ç´„ã—ã¾ã—ãŸ!', 'success');
            } else {
                showToast('ã‚¨ãƒ©ãƒ¼: ' + (response.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
            }
        })
        .fail(function(xhr, status, error) {
            showToast('URLè¦ç´„ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'error');
        })
        .always(function() {
            // â­ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
            $('#loadingCard').hide();
            $('#fetchUrlBtn').prop('disabled', false).html('<i class="fas fa-magic me-1"></i>è¦ç´„');
            resetProgress();  // â­ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        });
}

function handleProcess(summaryMode = 'short') {
    let data = {};
    let endpoint = '';
    
    // â­ é€²æ—è¡¨ç¤ºã‚’é–‹å§‹
    $('#progressArea').show();
    $('#progressBar').css('width', '0%');
    $('#progressPercent').text('0%');
    $('#progressMessage').html('<i class="fas fa-spinner fa-spin me-2"></i>æº–å‚™ä¸­...');
    
    if (currentMode === 'url') {
        const url = $('#urlInput').val().trim();
        if (!url) {
            showToast('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            $('#progressArea').hide();
            return;
        }
        data = {
            url: url,
            summary_mode: summaryMode,  // ãƒœã‚¿ãƒ³ã‹ã‚‰æ¸¡ã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰
            source_lang: $('#sourceLang').val() || 'auto',
            target_lang: $('#targetLang').val() || 'jpn_Jpan',
            style: $('#summaryStyle').val() || 'balanced',
            model_type: $('#modelType').val() || 'huggingface'  // â­ ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—
        };
        endpoint = '/api/url-summarize';
    } else {
        const text = $('#inputText').val().trim();
        if (!text) {
            showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            $('#progressArea').hide();
            return;
        }
        
        if (currentMode === 'summarize') {
            data = {
                text: text,
                summary_mode: summaryMode,  // ãƒœã‚¿ãƒ³ã‹ã‚‰æ¸¡ã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰
                source_lang: $('#sourceLang').val() || 'auto',  // å…¥åŠ›è¨€èª
                target_lang: $('#targetLang').val() || 'jpn_Jpan',  // å‡ºåŠ›è¨€èª
                style: $('#summaryStyle').val() || 'balanced',  // â­ ã‚¹ã‚¿ã‚¤ãƒ«
                model_type: $('#modelType').val() || 'huggingface'  // â­ ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—
            };
            endpoint = '/api/summarize';
        } else if (currentMode === 'expand') {
            // â­ å…¥åŠ›æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯
            if (text.length > 300) {
                showToast('âš ï¸ å±•é–‹å…ƒãƒ†ã‚­ã‚¹ãƒˆã¯300æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ï¼ˆç¾åœ¨: ' + text.length + 'æ–‡å­—ï¼‰', 'warning');
                $('#processBtn').prop('disabled', false);
                return;
            }
            
            data = {
                text: text,
                target_length: parseInt($('#expandLength').val()) || 500,  // â­ å±•é–‹ãƒ¢ãƒ¼ãƒ‰ã®æ–‡å­—æ•°
                source_lang: $('#sourceLang').val() || 'auto',  // â­ å…¥åŠ›è¨€èªã‚’è¿½åŠ 
                target_lang: $('#targetLang').val() || 'jpn_Jpan'  // â­ å‡ºåŠ›è¨€èªã‚’è¿½åŠ 
            };
            endpoint = '/api/expand';
        /* â­ ã‚³ãƒ¼ãƒ‰è§£èª¬æ©Ÿèƒ½ã¯ä¸€æ™‚åœæ­¢
        } else if (currentMode === 'code') {
            // â­ ã‚³ãƒ¼ãƒ‰è§£èª¬ãƒ¢ãƒ¼ãƒ‰
            data = {
                code: text,
                language: $('#codeLang').val() || 'auto',
                target_lang: $('#targetLang').val() || 'jpn_Jpan'
            };
            endpoint = '/api/explain-code';
        */
        }
    }
    
    // UIæ›´æ–°
    $('#resultCard').hide();
    $('#processBtn').prop('disabled', true);
    
    // â­ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
    $('#loadingCard').show();
    
    // â­ é€²æ—ãƒãƒ¼ã‚’é–‹å§‹
    startProgressSimulation();
    
    // APIå®Ÿè¡Œ
    $.post(endpoint, data)
        .done(function(response) {
            completeProgress();  // â­ é€²æ—ãƒãƒ¼å®Œäº†
            
            // â­ ã‚¿ã‚¹ã‚¯IDã‚’ä¿å­˜ï¼ˆé€²æ—è¿½è·¡ç”¨ï¼‰
            if (response.task_id) {
                currentTaskId = response.task_id;
            }
            
            if (response.success) {
                displayResult(response);
                updateStats();
                showToast('âœ… å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ!', 'success');
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + response.error);
                showToast('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        })
        .fail(function() {
            // â­ ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
            if (window.elapsedTimeInterval) {
                clearInterval(window.elapsedTimeInterval);
                window.elapsedTimeInterval = null;
            }
            $('#progressArea').hide();
            alert('å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
            showToast('âŒ å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .always(function() {
            $('#loadingCard').hide();
            $('#processBtn').prop('disabled', false);
            resetProgress();  // â­ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        });
}

function displayResult(response) {
    if (currentMode === 'summarize' || currentMode === 'url') {
        // æ”¹è¡Œã‚’<br>ã‚¿ã‚°ã«å¤‰æ›ã—ã¦HTMLã¨ã—ã¦è¡¨ç¤º
        const formattedSummary = response.summary.replace(/\n/g, '<br>');
        $('#resultText').html(formattedSummary);
        $('#originalLength').text(response.original_length);
        $('#resultLength').text(response.summary_length);
        $('#ratio').text((response.compression_ratio * 100).toFixed(1) + '%');
    } else if (currentMode === 'expand') {
        // æ”¹è¡Œã‚’<br>ã‚¿ã‚°ã«å¤‰æ›ã—ã¦HTMLã¨ã—ã¦è¡¨ç¤º
        const formattedExpanded = response.expanded_text.replace(/\n/g, '<br>');
        $('#resultText').html(formattedExpanded);
        $('#originalLength').text(response.original_length);
        $('#resultLength').text(response.expanded_length);
        $('#ratio').text((response.expansion_ratio).toFixed(1) + 'x');
    } else if (currentMode === 'code') {
        // â­ ã‚³ãƒ¼ãƒ‰è§£èª¬ãƒ¢ãƒ¼ãƒ‰
        const formattedExplanation = response.explanation.replace(/\n/g, '<br>');
        $('#resultText').html(formattedExplanation);
        $('#originalLength').text(response.code_length + ' chars');
        $('#resultLength').text(response.explanation_length + ' chars');
        $('#ratio').text(response.detected_language || '-');
    }
    
    // â­ å®Ÿè¡Œæ™‚é–“ã®å®‰å…¨ãªè¡¨ç¤ºï¼ˆnull/undefinedå¯¾å¿œï¼‰
    const execTime = response.execution_time;
    if (execTime !== null && execTime !== undefined && !isNaN(execTime)) {
        $('#executionTime').text(execTime.toFixed(2) + 's');
    } else {
        $('#executionTime').text('-');
    }
    
    $('#resultCard').show();
    
    $('#resultCard')[0].scrollIntoView({behavior: 'smooth'});
}

function copyResult() {
    const resultText = $('#resultText').text();
    const copyBtn = $('#copyBtnText');
    
    navigator.clipboard.writeText(resultText).then(() => {
        // â­ æˆåŠŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        copyBtn.html('<i class="fas fa-check me-1"></i>ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!');
        $('#copyBtnText').closest('button').removeClass('btn-primary').addClass('btn-success');
        
        // 2ç§’å¾Œã«å…ƒã«æˆ»ã™
        setTimeout(() => {
            copyBtn.html('çµæœã‚’ã‚³ãƒ”ãƒ¼');
            $('#copyBtnText').closest('button').removeClass('btn-success').addClass('btn-primary');
        }, 2000);
    }).catch(err => {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
    });
}

// â­ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ (è¤‡æ•°å½¢å¼å¯¾å¿œ)
function exportAs(format) {
    const resultText = $('#resultText').text();
    const originalText = $('#inputText').val();
    const timestamp = new Date().toISOString().slice(0,19).replace(/:/g, '-');
    let content, mimeType, extension;
    
    switch(format) {
        case 'txt':
            content = resultText;
            mimeType = 'text/plain';
            extension = 'txt';
            break;
            
        case 'md':
            content = `# è¦ç´„çµæœ\n\n**ç”Ÿæˆæ—¥æ™‚**: ${new Date().toLocaleString('ja-JP')}\n\n## è¦ç´„\n\n${resultText}\n\n---\n\n## å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ\n\n${originalText}`;
            mimeType = 'text/markdown';
            extension = 'md';
            break;
            
        case 'html':
            content = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è¦ç´„çµæœ - recapisure</title>
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
        h1 { color: #2c3e50; }
        .summary { background: #f8f9fa; padding: 20px; border-left: 4px solid #3498db; }
        .meta { color: #7f8c8d; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>è¦ç´„çµæœ</h1>
    <p class="meta">ç”Ÿæˆæ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}</p>
    <div class="summary">
        <h2>è¦ç´„</h2>
        <p>${resultText.replace(/\n/g, '<br>')}</p>
    </div>
    <hr>
    <h2>å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ</h2>
    <p>${originalText.replace(/\n/g, '<br>')}</p>
    <footer>
        <p class="meta">Generated by <a href="https://github.com/TT0144/recapisure">recapisure</a></p>
    </footer>
</body>
</html>`;
            mimeType = 'text/html';
            extension = 'html';
            break;
            
        case 'json':
            const jsonData = {
                timestamp: new Date().toISOString(),
                mode: currentMode,
                original_text: originalText,
                summary: resultText,
                stats: {
                    original_length: $('#originalLength').text(),
                    result_length: $('#resultLength').text(),
                    ratio: $('#ratio').text(),
                    execution_time: $('#executionTime').text()
                },
                settings: {
                    source_lang: $('#sourceLang').val(),
                    target_lang: $('#targetLang').val(),
                    style: $('#summaryStyle').val(),
                    mode: $('#summaryLength').val()
                }
            };
            content = JSON.stringify(jsonData, null, 2);
            mimeType = 'application/json';
            extension = 'json';
            break;
    }
    
    const blob = new Blob([content], {type: mimeType});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `recapisure_${currentMode}_${timestamp}.${extension}`;
    a.click();
    URL.revokeObjectURL(url);
    
    // â­ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    showToast(`âœ… ${extension.toUpperCase()}å½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ!`);
}

function saveResult() {
    // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™
    exportAs('txt');
}

function newProcess() {
    $('#inputText').val('');
    $('#inputUrl').val('');
    $('#charCount').text('0');
    $('#resultCard').hide();
    $('#fileInput').val('');
    if (currentMode === 'url') {
        $('#inputUrl').focus();
    } else {
        $('#inputText').focus();
    }
}

function updateStats() {
    $.get('/api/stats', function(data) {
        $('#totalOperations').text(data.total_operations);
        $('#totalChars').text((data.total_text_processed / 1000).toFixed(1) + 'K');
        $('#avgTime').text(data.average_execution_time.toFixed(1) + 's');
    });
}

// â­ ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
function showToast(message, type = 'success') {
    const toastId = 'toast-' + Date.now();
    const iconMap = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle',
        warning: 'fa-exclamation-triangle'
    };
    const bgMap = {
        success: 'bg-success',
        error: 'bg-danger',
        info: 'bg-info',
        warning: 'bg-warning'
    };
    
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgMap[type]} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas ${iconMap[type]} me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    $('#toastContainer').append(toastHtml);
    const toastElement = new bootstrap.Toast(document.getElementById(toastId), {
        animation: true,
        autohide: true,
        delay: 3000
    });
    toastElement.show();
    
    // ãƒˆãƒ¼ã‚¹ãƒˆéè¡¨ç¤ºå¾Œã«å‰Šé™¤
    document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

// â­ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
function toggleFeedback() {
    const panel = $('#feedbackPanel');
    if (panel.is(':visible')) {
        panel.slideUp(300);
    } else {
        panel.slideDown(300);
        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‘ãƒãƒ«ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        setTimeout(() => {
            panel[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 350);
    }
}

// â­ é€²æ—ãƒãƒ¼ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
let progressInterval;
let currentProgress = 0;
let statusMessages = [];

function addStatusMessage(message, isDebug = false) {
    const timestamp = new Date().toLocaleTimeString('ja-JP');
    const icon = getIconForMessage(message);
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const userMessage = `
        <div class="mb-1 fade-in">
            <span class="text-muted">[${timestamp}]</span>
            <i class="${icon} me-1"></i>
            <span>${message}</span>
        </div>
    `;
    $('#statusLog').append(userMessage);
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    if (isDebug) {
        const debugMessage = `<div class="text-success">[${timestamp}] ${message}</div>`;
        $('#debugLog').append(debugMessage);
    }
    
    // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    $('#statusLog').scrollTop($('#statusLog')[0].scrollHeight);
    $('#debugLog').scrollTop($('#debugLog')[0].scrollHeight);
}

function getIconForMessage(message) {
    if (message.includes('å®Œäº†') || message.includes('æˆåŠŸ')) return 'fas fa-check-circle text-success';
    if (message.includes('ã‚¨ãƒ©ãƒ¼') || message.includes('å¤±æ•—')) return 'fas fa-times-circle text-danger';
    if (message.includes('ç¿»è¨³')) return 'fas fa-language text-primary';
    if (message.includes('è¦ç´„')) return 'fas fa-compress text-info';
    if (message.includes('ãƒ¢ãƒ‡ãƒ«') || message.includes('ãƒ­ãƒ¼ãƒ‰')) return 'fas fa-download text-warning';
    if (message.includes('ãƒãƒ£ãƒ³ã‚¯') || message.includes('åˆ†å‰²')) return 'fas fa-cut text-secondary';
    return 'fas fa-spinner fa-spin text-primary';
}

function startProgressSimulation() {
    currentProgress = 0;
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
    $('#loading-title').text('å‡¦ç†ä¸­...');
    $('#loading-description').text('æ–‡ç« ã‚’åˆ†æã—ã¦ã„ã¾ã™');
    
    // â­ å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆæœŸåŒ–ãƒ»è¡¨ç¤º
    initProcessingSteps();
    
    // çµŒéæ™‚é–“ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’é–‹å§‹
    window.loadingStartTime = Date.now();
    window.elapsedTimeInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - window.loadingStartTime) / 1000);
        $('#elapsedTime').text(elapsed);
        
        // â­ æ™‚é–“çµŒéã«å¿œã˜ã¦ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ›´æ–°
        updateProcessingStepsByTime(elapsed);
        
        // 30ç§’è¶…ãˆãŸã‚‰è­¦å‘Šè‰²ã«å¤‰æ›´
        if (elapsed >= 30 && elapsed < 60) {
            $('#elapsedTimeDisplay').removeClass('bg-secondary bg-danger').addClass('bg-warning');
        } else if (elapsed >= 60) {
            $('#elapsedTimeDisplay').removeClass('bg-secondary bg-warning').addClass('bg-danger');
        }
    }, 1000);
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’100%ï¼ˆã‚¤ãƒ³ãƒ‡ã‚¿ãƒ¼ãƒŸãƒãƒ¼ãƒˆè¡¨ç¤ºï¼‰ã«è¨­å®š
    $('#progressBar').css('width', '100%');
    $('#progressText').text('å‡¦ç†ä¸­...');
}

// â­ å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—åˆæœŸåŒ–
function initProcessingSteps() {
    const sourceLang = $('#sourceLang').val();
    const targetLang = $('#targetLang').val();
    const needsTranslation = sourceLang !== targetLang && sourceLang !== 'auto';
    
    // å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
    $('#step-analyze, #step-translate, #step-summarize, #step-format').show();
    
    // ã‚¢ã‚¤ã‚³ãƒ³ã¨çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    resetStepState('analyze', 'ãƒ†ã‚­ã‚¹ãƒˆåˆ†æä¸­...', true);
    
    if (needsTranslation || currentMode === 'url') {
        resetStepState('translate', 'ç¿»è¨³å‡¦ç†å¾…æ©Ÿä¸­', false);
    } else {
        $('#step-translate').hide();
    }
    
    resetStepState('summarize', currentMode === 'expand' ? 'æ–‡ç« å±•é–‹å¾…æ©Ÿä¸­' : 'è¦ç´„ç”Ÿæˆå¾…æ©Ÿä¸­', false);
    resetStepState('format', 'çµæœæ•´å½¢å¾…æ©Ÿä¸­', false);
    
    // è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    $('#processing-detail').text('AIãŒæ–‡ç« ã‚’ç†è§£ã—ã¦ã„ã¾ã™...');
}

// â­ ã‚¹ãƒ†ãƒƒãƒ—çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
function resetStepState(stepName, text, isActive) {
    const iconEl = $(`#step-${stepName}-icon`);
    const textEl = $(`#step-${stepName}-text`);
    
    if (isActive) {
        iconEl.removeClass('fa-circle fa-check-circle text-success text-muted')
              .addClass('fa-circle-notch fa-spin text-primary');
        textEl.removeClass('text-muted text-success').addClass('text-primary fw-bold');
    } else {
        iconEl.removeClass('fa-circle-notch fa-spin fa-check-circle text-primary text-success')
              .addClass('fa-circle text-muted');
        textEl.removeClass('text-primary text-success fw-bold').addClass('text-muted');
    }
    textEl.text(text);
}

// â­ ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Œäº†çŠ¶æ…‹ã«
function completeStep(stepName, text) {
    const iconEl = $(`#step-${stepName}-icon`);
    const textEl = $(`#step-${stepName}-text`);
    
    iconEl.removeClass('fa-circle fa-circle-notch fa-spin text-muted text-primary')
          .addClass('fa-check-circle text-success');
    textEl.removeClass('text-muted text-primary fw-bold').addClass('text-success');
    textEl.text(text);
}

// â­ ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
function activateStep(stepName, text) {
    const iconEl = $(`#step-${stepName}-icon`);
    const textEl = $(`#step-${stepName}-text`);
    
    iconEl.removeClass('fa-circle fa-check-circle text-muted text-success')
          .addClass('fa-circle-notch fa-spin text-primary');
    textEl.removeClass('text-muted text-success').addClass('text-primary fw-bold');
    textEl.text(text);
}

// â­ æ™‚é–“çµŒéã«å¿œã˜ã¦ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ›´æ–°
function updateProcessingStepsByTime(elapsed) {
    const detailMessages = {
        analyze: [
            'ãƒ†ã‚­ã‚¹ãƒˆã®æ§‹é€ ã‚’è§£æä¸­...',
            'è¨€èªã‚’è‡ªå‹•æ¤œå‡ºä¸­...',
            'æ–‡ç« ã®æ„å‘³ã‚’ç†è§£ä¸­...',
            'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºä¸­...'
        ],
        translate: [
            'ç¿»è¨³ãƒ¢ãƒ‡ãƒ«ã‚’æº–å‚™ä¸­...',
            'ç¿»è¨³å‡¦ç†ã‚’å®Ÿè¡Œä¸­...',
            'ç¿»è¨³çµæœã‚’æ¤œè¨¼ä¸­...'
        ],
        summarize: [
            'é‡è¦ãªæƒ…å ±ã‚’æŠ½å‡ºä¸­...',
            'è¦ç´„æ–‡ã‚’ç”Ÿæˆä¸­...',
            'æ–‡ç« ã®ä¸€è²«æ€§ã‚’ç¢ºèªä¸­...'
        ],
        expand: [
            'ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†æä¸­...',
            'è©³ç´°ãªèª¬æ˜ã‚’ç”Ÿæˆä¸­...',
            'è¡¨ç¾ã‚’è±Šã‹ã«ã—ã¦ã„ã¾ã™...'
        ],
        format: [
            'å‡ºåŠ›å½¢å¼ã‚’æ•´å½¢ä¸­...',
            'æœ€çµ‚ãƒã‚§ãƒƒã‚¯ä¸­...'
        ]
    };
    
    // çµŒéæ™‚é–“ã«å¿œã˜ã¦ã‚¹ãƒ†ãƒƒãƒ—ã‚’é€²ã‚ã‚‹
    if (elapsed < 3) {
        $('#processing-detail').text(detailMessages.analyze[elapsed % detailMessages.analyze.length]);
    } else if (elapsed < 8) {
        completeStep('analyze', 'ãƒ†ã‚­ã‚¹ãƒˆåˆ†æå®Œäº† âœ“');
        if ($('#step-translate').is(':visible')) {
            activateStep('translate', 'ç¿»è¨³å‡¦ç†ä¸­...');
            $('#processing-detail').text(detailMessages.translate[(elapsed - 3) % detailMessages.translate.length]);
        } else {
            const msgs = currentMode === 'expand' ? detailMessages.expand : detailMessages.summarize;
            activateStep('summarize', currentMode === 'expand' ? 'æ–‡ç« å±•é–‹ä¸­...' : 'è¦ç´„ç”Ÿæˆä¸­...');
            $('#processing-detail').text(msgs[(elapsed - 3) % msgs.length]);
        }
    } else if (elapsed < 15) {
        completeStep('analyze', 'ãƒ†ã‚­ã‚¹ãƒˆåˆ†æå®Œäº† âœ“');
        if ($('#step-translate').is(':visible')) {
            completeStep('translate', 'ç¿»è¨³å‡¦ç†å®Œäº† âœ“');
        }
        const msgs = currentMode === 'expand' ? detailMessages.expand : detailMessages.summarize;
        activateStep('summarize', currentMode === 'expand' ? 'æ–‡ç« å±•é–‹ä¸­...' : 'è¦ç´„ç”Ÿæˆä¸­...');
        $('#processing-detail').text(msgs[(elapsed - 8) % msgs.length]);
    } else {
        completeStep('analyze', 'ãƒ†ã‚­ã‚¹ãƒˆåˆ†æå®Œäº† âœ“');
        if ($('#step-translate').is(':visible')) {
            completeStep('translate', 'ç¿»è¨³å‡¦ç†å®Œäº† âœ“');
        }
        completeStep('summarize', currentMode === 'expand' ? 'æ–‡ç« å±•é–‹å®Œäº† âœ“' : 'è¦ç´„ç”Ÿæˆå®Œäº† âœ“');
        activateStep('format', 'çµæœã‚’æ•´å½¢ä¸­...');
        $('#processing-detail').text(detailMessages.format[(elapsed - 15) % detailMessages.format.length]);
    }
}

function updateProgress(percent, message, step) {
    currentProgress = percent;
    $('#loading-description').text(message);
}

function completeProgress() {
    // â­ çµŒéæ™‚é–“ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
    if (window.elapsedTimeInterval) {
        clearInterval(window.elapsedTimeInterval);
        window.elapsedTimeInterval = null;
    }
    
    // â­ å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Œäº†çŠ¶æ…‹ã«
    completeStep('analyze', 'ãƒ†ã‚­ã‚¹ãƒˆåˆ†æå®Œäº† âœ“');
    if ($('#step-translate').is(':visible')) {
        completeStep('translate', 'ç¿»è¨³å‡¦ç†å®Œäº† âœ“');
    }
    completeStep('summarize', currentMode === 'expand' ? 'æ–‡ç« å±•é–‹å®Œäº† âœ“' : 'è¦ç´„ç”Ÿæˆå®Œäº† âœ“');
    completeStep('format', 'çµæœæ•´å½¢å®Œäº† âœ“');
    $('#processing-detail').text('ğŸ‰ å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    
    // å®Œäº†è¡¨ç¤º
    const totalTime = Math.floor((Date.now() - window.loadingStartTime) / 1000);
    $('#progressText').text('å®Œäº†!');
    $('#progressBar').removeClass('progress-bar-animated').css('background', '#28a745');
    $('#elapsedTimeDisplay').removeClass('bg-warning bg-danger').addClass('bg-success');
    $('#elapsedTime').text(totalTime);
    
    setTimeout(() => {
        resetProgress();
    }, 1000);
}

function resetProgress() {
    currentProgress = 0;
    $('#progressBar').css('width', '0%').addClass('progress-bar-animated').css('background', '#0066cc');
    $('#progressText').text('0%');
    $('#elapsedTime').text('0');
    $('#elapsedTimeDisplay').removeClass('bg-success bg-warning bg-danger').addClass('bg-primary');
    
    // ã‚¿ã‚¤ãƒãƒ¼ãŒæ®‹ã£ã¦ã„ãŸã‚‰ã‚¯ãƒªã‚¢
    if (window.elapsedTimeInterval) {
        clearInterval(window.elapsedTimeInterval);
        window.elapsedTimeInterval = null;
    }
}

// â­ AIå“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºï¼ˆå°±æ´»ã‚¢ãƒ”ãƒ¼ãƒ«ç”¨ï¼‰
function displayQualityMetrics(metrics) {
    if (!metrics) return;
    
    // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
    $('#qualityMetrics').fadeIn();
    
    // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã¨ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
    const confidence = metrics.confidence_score || 0;
    const coverage = metrics.information_coverage || metrics.keyword_coverage || 0;  // â­ æƒ…å ±ç¶²ç¾…ç‡ã‚’å„ªå…ˆ
    const naturalness = metrics.naturalness || 0;
    const compression = metrics.compression_ratio || 0;
    
    $('#confidenceScore').text(confidence.toFixed(1) + '%');
    $('#confidenceBar').css('width', confidence + '%');
    
    $('#coverageScore').text(coverage.toFixed(1) + '%');
    $('#coverageBar').css('width', coverage + '%');
    
    $('#naturalnessScore').text(naturalness.toFixed(1) + '%');
    $('#naturalnessBar').css('width', naturalness + '%');
    
    $('#compressionScore').text(compression.toFixed(1) + '%');
    $('#compressionBar').css('width', compression + '%');
    
    // å“è³ªãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸
    const qualityColor = metrics.quality_color || 'secondary';
    const qualityLevel = metrics.quality_level || 'æ¨™æº–';
    $('#qualityBadge')
        .removeClass('bg-success bg-info bg-warning bg-danger bg-secondary')
        .addClass('bg-' + qualityColor)
        .text(qualityLevel);
    
    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æƒ…å ±
    if (metrics.performance) {
        $('#performanceLevel').text(metrics.performance.performance_level);
        $('#performanceIcon').text(metrics.performance.performance_icon);
    }
    
    // ãƒ¢ãƒ‡ãƒ«æƒ…å ±
    if (metrics.model_info) {
        const modelText = metrics.model_info.type + ' (' + metrics.model_info.optimization + ')';
        $('#modelName').text(modelText);
    }
    
    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º
    if (metrics.top_keywords && metrics.top_keywords.length > 0) {
        const keywordBadges = metrics.top_keywords.map(kw => 
            `<span class="badge bg-secondary me-1">${kw}</span>`
        ).join('');
        $('#topKeywords').html(keywordBadges);
    }
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
    setTimeout(() => {
        $('.progress-bar').addClass('progress-bar-animated');
    }, 100);
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
function setMode(mode) {
    $(`#mode-${mode}`).prop('checked', true);
    currentMode = mode;
    updateModeDisplay();
}

// ğŸ“ Apertuså­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ  - ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½

// ã‚¿ã‚¹ã‚¯IDç”Ÿæˆ
function generateTaskId() {
    return 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// ã‚¹ã‚³ã‚¢è¡¨ç¤ºæ›´æ–°
function updateScoreDisplay(sliderId, displayId) {
    const value = parseFloat(document.getElementById(sliderId).value);
    document.getElementById(displayId).textContent = value.toFixed(1);
}

// ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡
function submitFeedback() {
    if (!window.lastResult) {
        showToast('å‡¦ç†çµæœãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
    }

    const feedbackData = {
        task_id: window.lastResult.taskId,
        original_text: window.lastResult.originalText,
        result_text: window.lastResult.resultText,
        task_type: window.lastResult.taskType,
        model_used: window.lastResult.modelUsed,
        user_score: parseFloat($('#userScore').val()),
        accuracy_score: parseFloat($('#accuracyScore').val()),
        fluency_score: parseFloat($('#fluencyScore').val()),
        completeness_score: parseFloat($('#completenessScore').val()),
        comment: $('#feedbackComment').val().trim()
    };

    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const submitBtn = $('#feedbackPanel button[onclick="submitFeedback()"]');
    const originalText = submitBtn.html();
    submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>é€ä¿¡ä¸­...');

    $.ajax({
        url: '/api/feedback',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(feedbackData),
        success: function(response) {
            if (response.success) {
                $('#feedbackSuccess').show();
                showToast('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼AIãŒå­¦ç¿’ã—ã¾ã™ã€‚', 'success');
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                $('#userScore, #accuracyScore, #fluencyScore, #completenessScore').val(3.0);
                $('.badge[id$="ScoreValue"]').text('3.0');
                $('#feedbackComment').val('');
                
                // 3ç§’å¾Œã«ãƒ‘ãƒãƒ«ã‚’æŠ˜ã‚ŠãŸãŸã‚€
                setTimeout(() => {
                    $('#feedbackPanel').slideUp();
                }, 3000);
            } else {
                showToast('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.error, 'error');
            }
        },
        error: function(xhr, status, error) {
            showToast('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
            console.error('Feedback error:', error);
        },
        complete: function() {
            submitBtn.prop('disabled', false).html(originalText);
        }
    });
}
</script>
{% endblock %}