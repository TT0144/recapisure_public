{% extends "base.html" %}

{% block title %}AIè¨­å®š - recapisure{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-robot me-2"></i>AIè¨­å®šã¨ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-2">ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹</h6>
                            <div id="serviceStatus" class="mb-3">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                                </div>
                                çŠ¶æ…‹ã‚’ç¢ºèªä¸­...
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-2">ç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«</h6>
                            <div id="currentModel" class="mb-3">
                                <span class="badge bg-info">èª­ã¿è¾¼ã¿ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¢ãƒ‡ãƒ«é¸æŠ -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>ğŸ‡¨ğŸ‡­ Apertusãƒ¢ãƒ‡ãƒ«è¨­å®š
                    </h4>
                </div>
                <div class="card-body">
                    <form id="modelForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="modelSelect" class="form-label">ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«</label>
                                <select class="form-select" id="modelSelect">
                                    <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
                                </select>
                                <div class="form-text">
                                    å‡¦ç†ã«ä½¿ç”¨ã™ã‚‹AIãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ãƒ¢ãƒ‡ãƒ«æƒ…å ±</label>
                                <div id="modelInfo" class="p-3 border rounded bg-light">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                                    </div>
                                    ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary" id="saveModelBtn" onclick="saveModelPreference()">
                                <i class="fas fa-save me-1"></i>è¨­å®šã‚’ä¿å­˜
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="testConnection()">
                                <i class="fas fa-plug me-1"></i>æ¥ç¶šãƒ†ã‚¹ãƒˆ
                            </button>
                            <button type="button" class="btn btn-outline-info ms-2" onclick="loadRecommendedModel()">
                                <i class="fas fa-magic me-1"></i>æ¨å¥¨ãƒ¢ãƒ‡ãƒ«ã‚’é©ç”¨
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- APIè¨­å®š -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-key me-2"></i>APIè¨­å®š
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        APIè¨­å®šã¯ç’°å¢ƒå¤‰æ•°ï¼ˆ.envãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚
                        å¤‰æ›´ã™ã‚‹ã«ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold">Apertus API</h6>
                            <div class="mb-2">
                                <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> 
                                <span id="apertusStatus" class="badge bg-secondary">ç¢ºèªä¸­...</span>
                            </div>
                            <div class="mb-2">
                                <strong>ãƒ™ãƒ¼ã‚¹URL:</strong> 
                                <code id="apertusUrl">-</code>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">ä½¿ç”¨é‡çµ±è¨ˆ</h6>
                            <div class="mb-2">
                                <strong>ä»Šæ—¥ã®å‡¦ç†æ•°:</strong> 
                                <span id="todayCount" class="fw-bold">-</span>
                            </div>
                            <div class="mb-2">
                                <strong>ç·ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³:</strong> 
                                <span id="totalTokens" class="fw-bold">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®š -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-tachometer-alt me-2"></i>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®š
                    </h4>
                </div>
                <div class="card-body">
                    <form id="performanceForm">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="requestTimeout" class="form-label">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (ç§’)</label>
                                <input type="number" class="form-control" id="requestTimeout" min="10" max="120" value="30">
                            </div>
                            <div class="col-md-4">
                                <label for="maxRetries" class="form-label">æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°</label>
                                <input type="number" class="form-control" id="maxRetries" min="1" max="5" value="3">
                            </div>
                            <div class="col-md-4">
                                <label for="temperature" class="form-label">å‰µé€ æ€§ãƒ¬ãƒ™ãƒ« (0.0-2.0)</label>
                                <input type="number" class="form-control" id="temperature" min="0" max="2" step="0.1" value="0.7">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-info">
                                <i class="fas fa-save me-1"></i>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®šã‚’ä¿å­˜
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- è¨ºæ–­æƒ…å ± -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-stethoscope me-2"></i>ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold">ä¾å­˜é–¢ä¿‚</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Flask</li>
                                <li><i class="fas fa-check text-success me-2"></i>Requests</li>
                                <li id="beautifulSoupStatus"><i class="fas fa-times text-danger me-2"></i>BeautifulSoup4</li>
                                <li id="apertusClientStatus"><i class="fas fa-times text-danger me-2"></i>Apertus Client</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h6>
                            <div class="small">
                                <div><strong>Python:</strong> <span id="pythonVersion">-</span></div>
                                <div><strong>ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> 1.0.0</div>
                                <div><strong>èµ·å‹•æ™‚é–“:</strong> <span id="uptime">-</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-dark" onclick="runDiagnostics()">
                            <i class="fas fa-play me-1"></i>è¨ºæ–­ã‚’å®Ÿè¡Œ
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="exportDiagnostics()">
                            <i class="fas fa-download me-1"></i>è¨ºæ–­çµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let serviceStatus = null;

$(document).ready(function() {
    loadServiceStatus();
    loadAvailableModels();
    loadSystemInfo();
});

function loadServiceStatus() {
    // Apertusã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
    $.get('/api/apertus/status', function(data) {
        if (data.success) {
            serviceStatus = data.status;
            updateServiceStatusDisplay(data);
        }
    }).fail(function() {
        $('#serviceStatus').html('<span class="text-danger">ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</span>');
    });
}

function updateServiceStatusDisplay(data) {
    const statusHtml = data.available ? 
        '<span class="badge bg-success"><i class="fas fa-check me-1"></i>åˆ©ç”¨å¯èƒ½</span>' :
        '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle me-1"></i>åˆ¶é™ä»˜ã</span>';
    
    const learningInfo = data.learning_enabled ? 
        `<small class="text-success d-block mt-1">å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ æœ‰åŠ¹ (${data.feedback_count}ä»¶ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯)</small>` : 
        '<small class="text-muted d-block mt-1">å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ç„¡åŠ¹</small>';
    
    $('#serviceStatus').html(statusHtml + learningInfo);
    
    if (data.status && data.status.model_display_name) {
        $('#currentModel').html(`<span class="badge bg-info">${data.status.model_display_name}</span>`);
    }
    
    // APIçŠ¶æ…‹æ›´æ–°
    const apertusStatusBadge = data.available ? 
        '<span class="badge bg-success">å‹•ä½œä¸­</span>' :
        '<span class="badge bg-warning">åˆ¶é™ãƒ¢ãƒ¼ãƒ‰</span>';
    $('#apertusStatus').html(apertusStatusBadge);
}

function loadAvailableModels() {
    $.get('/api/apertus/models', function(data) {
        if (data.success) {
            const select = $('#modelSelect');
            select.empty();
            
            // æ¨å¥¨ãƒ¢ãƒ‡ãƒ«ã‚’ä¿å­˜
            window.recommendedModel = data.recommended;
            
            // ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            Object.keys(data.models).forEach(key => {
                const model = data.models[key];
                const badge = key === data.recommended ? ' ğŸŒŸ' : '';
                const option = $('<option></option>')
                    .val(key)
                    .text(`${model.name}${badge}`)
                    .data('model', model);
                
                if (key === data.recommended) {
                    option.prop('selected', true);
                }
                
                select.append(option);
            });
            
            // ãƒ¢ãƒ‡ãƒ«é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            select.change(function() {
                const selectedOption = $(this).find('option:selected');
                const modelData = selectedOption.data('model');
                updateModelInfo(modelData);
            });
            
            // åˆæœŸé¸æŠã®ãƒ¢ãƒ‡ãƒ«æƒ…å ±è¡¨ç¤º
            const initialModel = select.find('option:selected').data('model');
            if (initialModel) {
                updateModelInfo(initialModel);
            }
        }
    }).fail(function() {
        $('#modelInfo').html('<span class="text-danger">ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</span>');
    });
}

function updateModelInfo(model) {
    if (!model) return;
    
    const gpuBadge = model.requires_gpu ? 
        '<span class="badge bg-danger ms-1">GPUå¿…é ˆ</span>' : 
        '<span class="badge bg-success ms-1">CPUå¯</span>';
    
    const html = `
        <div class="mb-2"><strong>ãƒ¢ãƒ‡ãƒ«å:</strong> ${model.name} ${gpuBadge}</div>
        <div class="mb-2"><strong>ã‚µã‚¤ã‚º:</strong> ${model.size}</div>
        <div class="mb-2"><strong>ãƒ¡ãƒ¢ãƒªè¦ä»¶:</strong> ${model.memory_gb}GB</div>
        <div class="mb-2"><strong>èª¬æ˜:</strong> ${model.description}</div>
        <div class="small text-muted mt-2">
            <strong>ãƒ¢ãƒ‡ãƒ«ID:</strong> <code>${model.model_id}</code>
        </div>
    `;
    
    $('#modelInfo').html(html);
}

function saveModelPreference() {
    const selectedKey = $('#modelSelect').val();
    if (!selectedKey) return;
    
    const btn = $('#saveModelBtn');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...').prop('disabled', true);
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    localStorage.setItem('preferred_apertus_model', selectedKey);
    
    setTimeout(function() {
        btn.html('<i class="fas fa-check me-1"></i>ä¿å­˜å®Œäº†!').removeClass('btn-primary').addClass('btn-success');
        
        setTimeout(function() {
            btn.html(originalText).removeClass('btn-success').addClass('btn-primary').prop('disabled', false);
        }, 2000);
    }, 500);
}

function loadRecommendedModel() {
    if (window.recommendedModel) {
        $('#modelSelect').val(window.recommendedModel).trigger('change');
        alert(`æ¨å¥¨ãƒ¢ãƒ‡ãƒ« "${window.recommendedModel}" ã‚’é©ç”¨ã—ã¾ã—ãŸ`);
    }
}

function loadSystemInfo() {
    // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã®å–å¾—ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯é©åˆ‡ãªAPIã‚’ä½¿ç”¨ï¼‰
    $('#pythonVersion').text('3.11+');
    $('#uptime').text('èµ·å‹•ä¸­...');
    
    // ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
    $('#beautifulSoupStatus').html('<i class="fas fa-check text-success me-2"></i>BeautifulSoup4');
    $('#apertusClientStatus').html('<i class="fas fa-check text-success me-2"></i>Apertus Client');
}

$('#modelForm').submit(function(e) {
    e.preventDefault();
    
    const selectedModel = $('#modelSelect').val();
    if (!selectedModel) return;
    
    const btn = $('#saveModelBtn');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...').prop('disabled', true);
    
    $.post('/api/change-model', {
        model: selectedModel
    }, function(data) {
        if (data.success) {
            alert('ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            loadServiceStatus();
        } else {
            alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
        }
    }).fail(function() {
        alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }).always(function() {
        btn.html(originalText).prop('disabled', false);
    });
});

$('#performanceForm').submit(function(e) {
    e.preventDefault();
    
    const settings = {
        timeout: $('#requestTimeout').val(),
        retries: $('#maxRetries').val(),
        temperature: $('#temperature').val()
    };
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯é©åˆ‡ãªAPIã‚’ä½¿ç”¨ï¼‰
    localStorage.setItem('performanceSettings', JSON.stringify(settings));
    alert('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
});

function testConnection() {
    const btn = $('button[onclick="testConnection()"]');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>ãƒ†ã‚¹ãƒˆä¸­...').prop('disabled', true);
    
    $.get('/api/health-check', function(data) {
        if (data.success) {
            alert('æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼');
        } else {
            alert('æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ' + data.error);
        }
    }).fail(function() {
        alert('æ¥ç¶šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    }).always(function() {
        btn.html(originalText).prop('disabled', false);
    });
}

function runDiagnostics() {
    alert('è¨ºæ–­æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™');
}

function exportDiagnostics() {
    const diagnostics = {
        timestamp: new Date().toISOString(),
        service_status: serviceStatus,
        browser_info: navigator.userAgent,
        screen_resolution: `${screen.width}x${screen.height}`,
        url: window.location.href
    };
    
    const blob = new Blob([JSON.stringify(diagnostics, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `recapisure_diagnostics_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}